<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Toy City ‚Äì Order Portal</title>
<style>
  /* ...‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì... */

  /* Timeline */
  .timeline{position:relative;padding-left:28px;margin-top:14px}
  .timeline::before{content:'';position:absolute;left:12px;top:0;bottom:0;width:4px;background:#e2e8f0;border-radius:2px}
  .tl-item{position:relative;margin:12px 0;padding-left:12px}
  .tl-dot{position:absolute;left:-2px;top:2px;width:16px;height:16px;border-radius:50%;background:#667eea;box-shadow:0 0 0 3px #eef2ff inset}
  .tl-icon{position:absolute;left:-1px;top:-1px;font-size:14px;line-height:16px;text-align:center;width:16px;height:16px;color:#fff}
  .tl-title{font-weight:700;color:#1a202c}
  .tl-time{color:#718096;font-size:12px}
</style>
</head>
<body>
  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
  <div class="wrap card" id="tabCustomer">
    <h2>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á</h2>
    <div id="c-gate" class="info-box" style="display:none"></div>
    <div id="c-result"></div>
  </div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxxziOyC5TfTekQJuS5Gf5zwHHkw548EPjHgW7ji4gTlNnFGtFXoLTaFRwIiNoLERVpTQ/exec'; // <‚Äî URL /exec ‡∏Ç‡∏≠‡∏á GAS

/* ===== Utils ===== */
const qs = new URLSearchParams(location.search);
const BOOKING = qs.get('booking');
const TOKEN   = qs.get('token');

/* ===== Init ===== */
(async function init(){
  const gate = document.getElementById('c-gate');
  const out  = document.getElementById('c-result');

  if (!BOOKING || !TOKEN){
    gate.style.display='block';
    gate.innerHTML = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
    out.innerHTML  = '';
    return;
  }

  try{
    // 1) ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ token)
    const order = await fetchJSON(`${WEB_APP_URL}?action=order&booking=${encodeURIComponent(BOOKING)}&token=${encodeURIComponent(TOKEN)}`);
    if (!order.ok || !order.data){ out.innerHTML = err('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á'); return; }

    // 2) ‡∏î‡∏∂‡∏á‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå
    const tl = await fetchJSON(`${WEB_APP_URL}?action=timeline&booking=${encodeURIComponent(BOOKING)}&token=${encodeURIComponent(TOKEN)}`);
    renderOrder(order.data, tl.ok ? tl.data : []);
  }catch(e){
    out.innerHTML = err('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
  }
})();

/* ===== Rendering ===== */
function renderOrder(o, timeline){
  const c = document.getElementById('c-result');

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ + ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏™‡∏ß‡∏¢‡πÜ)
  const hasDisc = o.items.some(it => (it.disc||'').trim());
  const th = `
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏£‡∏ß‡∏° (‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î)</th>
      ${hasDisc?'<th>PROMOTION %</th><th>PROMOTION CODE</th><th>CONDITION</th>':''}
    </tr>`;

  const rows = o.items.map(it=>{
    const discText = displayDisc(it.disc); // 0.8 -> 80%
    return `
      <tr>
        <td>${esc(it.code)}</td>
        <td>${esc(it.desc)}</td>
        <td align="right">${num(it.price)}</td>
        <td align="right">${num(it.qty)}</td>
        <td align="right">${num(it.amountNet ?? it.amount)}</td>
        ${hasDisc?`
          <td>${discText||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
          <td>${esc(it.discCode||'‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
          <td>${esc(it.discRule||'‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>`:''}
      </tr>`;
  }).join('');

  // ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  const tlHtml = timeline.map(step=>{
    const icon = pickIcon(step.status);
    return `
      <div class="tl-item">
        <div class="tl-dot"></div>
        <div class="tl-icon">${icon}</div>
        <div class="tl-title">${esc(step.status)}</div>
        <div class="tl-time">${esc(step.when)}</div>
      </div>`;
  }).join('');

  c.innerHTML = `
  <div class="order-card">
    <div class="order-header">
      <div class="booking-number">üìã Booking #${o.booking}</div>
      <span class="badge">${esc(o.status)}</span>
    </div>
    <div class="muted">üë§ ${esc(o.customer.name)} ${esc(o.customer.last)} ¬∑ üìß ${esc(o.customer.email)} ¬∑ üìû ${esc(o.customer.tel)}<br>
        ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ${esc(o.fromShop||'-')} ‚Üí ${esc(o.toShop||'-')}
    </div>

    <div class="timeline">${tlHtml}</div>

    <table>
      <thead>${th}</thead>
      <tbody>${rows}</tbody>
      <tfoot>
        <tr>
          <td colspan="${hasDisc?5:4}" align="right"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></td>
          <td align="right"><b>${num(o.total)} ‡∏ö‡∏≤‡∏ó</b></td>
          ${hasDisc?'<td colspan="2"></td>':''}
        </tr>
      </tfoot>
    </table>
  </div>`;
}

/* ===== Helpers ===== */
async function fetchJSON(url){ const r = await fetch(url); return r.json(); }
function esc(s){ return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
function num(n){ return Number(n||0).toLocaleString('th-TH'); }
function err(m){ return `<div class="alert error">‚ùå ${m}</div>`; }
function displayDisc(v){
  const s = String(v==null?'':v).trim();
  if (!s) return '';
  if (/%$/.test(s)) return s;                  // "80%"
  const n = parseFloat(s);
  if (isNaN(n)) return s;
  return (n>1 ? n : n*100) + '%';              // 0.8 -> 80%
}
function pickIcon(status){
  if (!status) return '‚Ä¢';
  if (status.includes('‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'))                return 'üìù';
  if (status.includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'))                    return 'üöö';
  if (status.includes('‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô'))                   return 'üè¨';
  if (status.includes('‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'))                 return '‚úÖ';
  return '‚Ä¢';
}
</script>
</body>
</html>
