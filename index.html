<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Toy City ‚Äì Order Portal</title>

<!-- ===== Theme ===== -->
<style>
:root{
  --bg:#f6f7fb;
  --card:#ffffff;
  --title:#151a2d;
  --text:#2c334a;
  --sub:#66708a;
  --line:#e8eaf2;
  --brand:#5c6cff;
  --brand-2:#6e87ff;
  --ok:#22c55e;
  --warn:#fb923c;
  --danger:#ef4444;
  --pill:#eef2ff;
  --pill2:#f1f5f9;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--text);
  font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;
}
.container{max-width:1080px;margin:28px auto;padding:0 14px}
.row{display:flex;gap:10px;align-items:center}
.space{flex:1}
h1{margin:0 0 14px;font-size:22px;color:var(--title)}
.card{
  background:var(--card); border:1px solid var(--line);
  border-radius:14px; padding:14px 16px; box-shadow:0 2px 0 rgba(0,0,0,.03)
}
.header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
.brand{display:flex;align-items:center;gap:8px;font-weight:700}
.brand i{font-style:normal;font-size:22px}
.tab-btn{
  background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 12px;
  cursor:pointer; color:var(--text)
}
.tab-btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
select,input{
  background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;
  outline:none; color:var(--text)
}
input[type="search"], input[type="text"], input[type="password"]{min-width:200px}
.btn{
  background:var(--brand);color:#fff;border:0;border-radius:10px;padding:8px 12px;
  cursor:pointer
}
.btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line)}
.btn.warn{background:var(--warn);color:#111}
.btn.ok{background:var(--ok)}
.muted{color:var(--sub);font-size:13px}
.right{text-align:right}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px 10px;border-top:1px solid var(--line);vertical-align:top}
.table thead th{background:#f6f7ff;color:#3b49a7}
.badge{
  display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;
  background:var(--pill);color:#3b49a7;border:1px solid #dfe3ff
}
.badge.ok{background:#ecfdf5;border-color:#c3f0db;color:#0f8a4b}
.badge.warn{background:#fff7ed;border-color:#ffe3c4;color:#b45309}
.badge.danger{background:#fef2f2;border-color:#fecaca;color:#b91c1c}

/* Timeline */
.tc-timeline{display:flex;gap:14px;margin:8px 0}
.tc-step{display:flex;flex-direction:column;align-items:center;gap:6px;width:90px}
.tc-icon{
  width:36px;height:36px;border-radius:999px;border:2px solid var(--line);
  display:grid;place-items:center;background:#fff;color:#9aa3ba;font-weight:700
}
.tc-step.active .tc-icon{border-color:var(--brand);color:var(--brand);box-shadow:0 0 0 4px #eef2ff}
.tc-step .lbl{font-size:12px;color:var(--sub);text-align:center}
.tc-step .ts{font-size:11px;color:#9aa3ba;text-align:center}

/* Admin extras */
.qr {
  width:64px;height:64px;border:1px solid var(--line);border-radius:10px;
  background:#fff;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.04)
}
.custline{margin-top:6px;color:var(--sub);font-size:14px}
.header-left{display:flex;align-items:center;gap:12px}
.grow{flex:1}
.hr{height:1px;background:var(--line);margin:10px 0}
.small{font-size:12px;color:var(--sub)}
</style>
</head>
<body>
<div class="container">

  <!-- ===== Top header ===== -->
  <div class="header">
    <div class="brand"><i>üéÆ</i> Toy City ‚Äì Order Portal</div>
    <div class="space"></div>
    <button id="btnCust" class="tab-btn primary" onclick="switchTab('cust')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    <button id="btnAdmin" class="tab-btn" onclick="switchTab('admin')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin</button>
  </div>

  <!-- ===== Customer view ===== -->
  <div id="custView" class="card" style="display:block">
    <h1>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á</h1>
    <div id="custBox" class="muted">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
  </div>

  <!-- ===== Admin view ===== -->
  <div id="adminView" style="display:none">
    <!-- Login card -->
    <div id="loginCard" class="card">
      <div class="row">
        <b>üîê Admin Console</b>
      </div>
      <div class="row" style="margin-top:6px">
        <input id="adminPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" />
        <button class="btn" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
      <div id="loginOK" class="small" style="display:none;margin-top:6px">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì</div>
    </div>

    <!-- Console -->
    <div id="console" class="card" style="margin-top:12px;display:none">
      <div class="row" style="flex-wrap:wrap;gap:8px 10px">
        <select id="filter-status">
          <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤(‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
          <option>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
          <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
        </select>

        <input id="filter-booking" type="search" placeholder="‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏à‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 102380)" />
        <select id="filter-shop"><option value="">From Shop: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>

        <div class="space"></div>
        <button class="btn ghost" onclick="loadAdmin()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>

      <div id="adminList" style="margin-top:12px"></div>
    </div>
  </div>

</div>

<!-- ===== App script ===== -->
<script>
/* ===================== CONFIG ===================== */
// !!! ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App (GAS) ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà !!!
const API = 'https://script.google.com/macros/s/AKfycbzc8m3R_sUQX3kDZEbYFYMwaNxrrju1VWkX6HGGCnUON9dR48p-woccIuddzk_8RxP_3g/exec'; // eg. https://script.google.com/macros/s/XXXX/exec
const ADMIN_PASS = '6515';

/* ===================== Helpers ===================== */
const $ = sel => document.querySelector(sel);
const qs = new URLSearchParams(location.search);
const fmtTH = new Intl.NumberFormat('th-TH');
const money = n => fmtTH.format(Number(n||0));

function switchTab(tab){
  const cust = $('#custView'), admin = $('#adminView');
  const bC = $('#btnCust'), bA = $('#btnAdmin');
  if (tab==='admin'){
    cust.style.display='none'; admin.style.display='';
    bC.classList.remove('primary'); bA.classList.add('primary');
  }else{
    cust.style.display=''; admin.style.display='none';
    bA.classList.remove('primary'); bC.classList.add('primary');
  }
}

/* ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ‚Üí ‡∏õ‡πâ‡∏≤‡∏¢ % */
function discLabel(v){
  if (v==null || v==='') return '‡πÑ‡∏°‡πà‡∏°‡∏µ';
  const s = String(v).trim().toLowerCase();
  const m = s.match(/(\d+(?:\.\d+)?)\s*%/);
  if (m) return `${+m[1]}%`;
  const n = parseFloat(s);
  if (isNaN(n)) return s;
  return n>1 ? `${n}%` : `${Math.round(n*100)}%`;
}

/* ‡∏™‡∏£‡πâ‡∏≤‡∏á URL QR */
function qrUrl(text){
  return 'https://quickchart.io/qr?text=' + encodeURIComponent(text) + '&size=96&margin=1';
}
/* ‡∏Ñ‡∏•‡∏¥‡∏Å QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ß */
function setFilter(booking){
  const inp = $('#filter-booking');
  if (inp){
    inp.value = booking;
    loadAdmin();
    inp.focus(); inp.select();
  }
}

/* ===================== Customer View ===================== */
async function loadCustomer(){
  const booking = qs.get('booking');
  const token   = qs.get('token');
  const box = $('#custBox');

  if (!booking || !token){
    box.innerHTML = '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô';
    return;
  }

  try{
    const res = await fetch(`${API}?action=order&booking=${encodeURIComponent(booking)}&token=${encodeURIComponent(token)}`);
    const j = await res.json();
    if (!j.ok || !j.data){ box.innerHTML = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; return; }
    const o = j.data;
    box.innerHTML = renderOrderForCustomer(o);
    buildTimeline(`tl-${o.booking}`, o.statusAt, o.status);
  }catch(e){
    box.innerHTML = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
  }
}

function renderOrderForCustomer(o){
  const items = (o.items||[]).map(it=>`
    <tr>
      <td>${it.code||''}</td>
      <td>${it.desc||''}</td>
      <td class="right">${money(it.price)}</td>
      <td class="right">${money(it.qty)}</td>
      <td class="right">
        ${Number(it.amountNet||0) < Number(it.amount||0)
          ? `<span class="muted" style="text-decoration:line-through">${money(it.amount)}</span> ‚Üí <b>${money(it.amountNet)}</b>`
          : `<b>${money(it.amountNet ?? it.amount)}</b>`}
      </td>
      <td>${discLabel(it.disc)}</td>
      <td>${it.discCode||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
      <td>${it.discRule||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
    </tr>`).join('');

  return `
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="header-left">
        <div><b>Booking #${o.booking}</b> <span class="badge">${o.status}</span></div>
        <img class="qr" src="${qrUrl(o.booking)}" alt="QR ${o.booking}">
      </div>
      <div class="muted">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô: ${o.fromShop||'-'} ‚Üí ${o.toShop||'-'}</div>
    </div>

    <div class="custline">
      ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <b>${(o.customer?.name||'') + ' ' + (o.customer?.last||'')}</b>
      &nbsp;‚Ä¢&nbsp; <a href="mailto:${o.customer?.email||''}">${o.customer?.email||'-'}</a>
      &nbsp;‚Ä¢&nbsp; ${o.customer?.tel||'-'}
    </div>
    <div class="muted">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${o.statusAt||'-'}</div>

    <div id="tl-${o.booking}" class="tc-timeline"></div>

    <table class="table" style="margin-top:6px">
      <thead>
        <tr>
          <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th class="right">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th>%</th><th>CODE</th><th>COND.</th>
        </tr>
      </thead>
      <tbody>${items}</tbody>
      <tfoot>
        <tr>
          <td colspan="7" class="right"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></td>
          <td class="right"><b>${money(o.total)}</b></td>
        </tr>
      </tfoot>
    </table>
  `;
}

/* ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå (‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢) */
function buildTimeline(elId, statusAt, status){
  const steps = [
    {key:'‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', label:'‡∏à‡∏≠‡∏á', icon:'üìù'},
    {key:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', label:'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°', icon:'üì¶'},
    {key:'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', label:'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', icon:'üöö'},           // ‡πÉ‡∏ä‡πâ startsWith
    {key:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', label:'‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô', icon:'üè¨'},
    {key:'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', label:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', icon:'‚úÖ'},
  ];
  let activeIdx = 0;
  if (status.startsWith('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) activeIdx = 2;
  else activeIdx = steps.findIndex(s=>s.key===status);
  if (activeIdx<0) activeIdx = 0;

  const ts = statusAt || '';
  const html = steps.map((s,i)=>`
    <div class="tc-step ${i<=activeIdx?'active':''}">
      <div class="tc-icon">${s.icon}</div>
      <div class="lbl">${s.label}</div>
      <div class="ts">${i===activeIdx? ts : ''}</div>
    </div>`).join('');
  const el = document.getElementById(elId);
  if (el) el.innerHTML = html;
}

/* ===================== Admin ===================== */
function login(){
  const val = $('#adminPass').value.trim();
  if (val === ADMIN_PASS){
    localStorage.setItem('toycity_admin', '1');
    $('#loginOK').style.display='block';
    $('#console').style.display='';
    loadAdmin();
  }else{
    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
  }
}
function ensureLogin(){
  if (localStorage.getItem('toycity_admin')==='1'){
    $('#loginOK').style.display='block';
    $('#console').style.display='';
  }
}
function statusBadge(t){
  let cls='badge';
  if (/‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à|‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/.test(t)) cls+=' ok';
  else if (/‡∏à‡∏±‡∏î‡∏™‡πà‡∏á/.test(t)) cls+=' warn';
  else if (/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/.test(t)) cls+=' danger';
  return `<span class="${cls}">${t}</span>`;
}

async function loadAdmin(){
  if (!localStorage.getItem('toycity_admin')) return;
  const q = new URLSearchParams({
    action:'list', adminKey: ADMIN_PASS
  });
  const res = await fetch(`${API}?${q.toString()}`);
  const j = await res.json();
  if (!j.ok){ alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; }

  const all = j.data || [];
  // ‡πÄ‡∏ï‡∏¥‡∏° From Shop dropdown
  const shopSel = $('#filter-shop');
  const currentShop = shopSel.value;
  const shops = [...new Set(all.map(o=>o.fromShop).filter(Boolean))].sort();
  shopSel.innerHTML = `<option value="">From Shop: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` +
    shops.map(s=>`<option ${currentShop===s?'selected':''}>${s}</option>`).join('');

  // ‡∏Å‡∏£‡∏≠‡∏á
  const st   = $('#filter-status').value.trim();
  const bk   = $('#filter-booking').value.trim();
  const fs   = $('#filter-shop').value.trim();

  const filtered = all.filter(o=>{
    if (st && o.status!==st && !(st.startsWith('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á') && o.status.startsWith('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á'))) return false;
    if (bk && String(o.booking)!==bk) return false;
    if (fs && String(o.fromShop)!==fs) return false;
    return true;
  });

  const list = $('#adminList');
  list.innerHTML = filtered.map(o=>{
    const items = (o.items||[]).map(it=>`
      <tr>
        <td>${it.code||''}</td><td>${it.desc||''}</td>
        <td class="right">${money(it.price)}</td>
        <td class="right">${money(it.qty)}</td>
        <td class="right">${money(it.amountNet||it.amount)}</td>
        <td>${discLabel(it.disc)}</td><td>${it.discCode||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td><td>${it.discRule||'‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
      </tr>`).join('');

    const cust = o.customer || {};
    return `
      <div class="card" style="margin-bottom:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="header-left">
            <div><b>Booking #${o.booking}</b> &nbsp; ${statusBadge(o.status)}</div>
            <img class="qr" src="${qrUrl(o.booking)}" alt="QR ${o.booking}" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
                 onclick="setFilter('${o.booking}')">
          </div>
          <div class="muted">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô: ${o.fromShop||'-'} ‚Üí ${o.toShop||'-'}</div>
        </div>

        <div class="custline">
          ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <b>${(cust.name||'') + ' ' + (cust.last||'')}</b>
          &nbsp;‚Ä¢&nbsp; <a href="mailto:${cust.email||''}">${cust.email||'-'}</a>
          &nbsp;‚Ä¢&nbsp; ${cust.tel||'-'}
        </div>
        <div class="muted">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${o.statusAt||'-'}</div>

        <div id="tl-${o.booking}" class="tc-timeline"></div>

        <table class="table" style="margin-top:6px">
          <thead>
            <tr>
              <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
              <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th class="right">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th><th>%</th><th>CODE</th><th>COND.</th>
            </tr>
          </thead>
          <tbody>${items}</tbody>
          <tfoot>
            <tr>
              <td colspan="7" class="right" style="font-weight:700">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
              <td class="right" style="font-weight:700">${money(o.total)}</td>
            </tr>
          </tfoot>
        </table>

        <div class="row" style="margin-top:10px">
          <select id="st-${o.booking}" class="grow">
            <option ${o.status==='‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'?'selected':''}>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
            <option ${o.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'?'selected':''}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
            <option ${o.status.startsWith('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')?'selected':''}>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤(‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
            <option ${o.status==='‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
            <option ${o.status==='‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'?'selected':''}>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
          </select>
          <button class="btn" onclick="updateStatus('${o.booking}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
          <div class="space"></div>
          <a class="btn ghost" href="${API}?action=html&booking=${o.booking}" target="_blank">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á (Thermal)</a>
          <a class="btn ghost" href="${API}?action=html&booking=${o.booking}" target="_blank">‡∏û‡∏¥‡∏°‡∏û‡πå A4</a>
        </div>
      </div>
    `;
  }).join('');

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Timeline ‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  filtered.forEach(o => buildTimeline(`tl-${o.booking}`, o.statusAt, o.status));
}

async function updateStatus(booking){
  const sel = document.getElementById(`st-${booking}`);
  const status = sel ? sel.value : '';
  if (!status) return;
  const q = new URLSearchParams({
    action:'update', adminKey: ADMIN_PASS, booking, status
  });
  const res = await fetch(`${API}?${q.toString()}`);
  const j = await res.json();
  if (j.ok) { loadAdmin(); alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'); }
  else alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

/* ===================== Init ===================== */
ensureLogin();
loadCustomer();

</script>
</body>
</html>

