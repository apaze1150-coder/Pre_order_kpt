<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Toy City ‚Äì Order Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f7fb;
    --card:#fff;
    --pri:#5b5bd6;
    --ink:#202235;
    --mut:#6b6f85;
    --bd:#e8e9f1;
    --ok:#2fbf71;
    --warn:#ffb100;
    --danger:#ea5252;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Prompt,system-ui,-apple-system,"Segoe UI",Arial,sans-serif}
  .wrap{max-width:1080px;margin:28px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .brand{font-weight:700;font-size:22px;display:flex;gap:10px;align-items:center}
  .brand i{font-style:normal;background:var(--pri);color:#fff;border-radius:10px;padding:6px 8px}
  .seg{display:flex;gap:8px}
  .seg .btn{padding:10px 14px;border:1px solid var(--bd);background:#fff;border-radius:10px;color:var(--ink);cursor:pointer}
  .seg .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}

  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;box-shadow:0 10px 20px rgba(32,34,53,.05);margin:14px 0}
  .card .head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--bd)}
  .bno{font-weight:700}
  .head .meta{display:flex;gap:14px;align-items:center;color:var(--mut);font-size:13px}
  .head .meta .chip{background:#eef1ff;color:#3b44b1;border-radius:999px;padding:6px 10px;font-weight:600}
  .qrcode{width:56px;height:56px;border-radius:10px;border:1px solid var(--bd);background:#fff;display:flex;align-items:center;justify-content:center}
  .qrcode img{width:48px;height:48px}

  .box{padding:12px 16px}
  .cust{display:flex;gap:10px;align-items:center;color:#374}
  .cust small{color:var(--mut)}
  .grid{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .timeline{display:flex;gap:28px;align-items:flex-start;margin-top:10px}
  .step{text-align:center;min-width:72px}
  .step .ico{width:46px;height:46px;border-radius:999px;border:2px solid var(--bd);display:flex;align-items:center;justify-content:center;margin:0 auto 6px}
  .step.active .ico{border-color:var(--pri);background:linear-gradient(#fff,#eef1ff)}
  .step .cap{font-size:12px;color:var(--mut)}
  .step .ts{font-size:10px;color:#9aa}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--bd);padding:8px 10px;text-align:left}
  th{background:#f3f4fb;font-weight:600;color:#3a3d58}
  tfoot td{font-weight:700}
  .right{text-align:right}
  .mut{color:var(--mut)}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .select, .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer}
  .btn.pri{background:var(--pri);border-color:var(--pri);color:#fff}
  .btn.link{background:#fff;color:#365; border-color:var(--bd)}
  .no-print{ /* ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡πÑ‡∏õ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå */ }

  @media print{
    body{background:#fff}
    .no-print{display:none!important}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><i>üéÆ</i> Toy City ‚Äì Order Portal</div>
      <div class="seg no-print">
        <button class="btn" onclick="switchMode('customer')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
        <button class="btn pri" onclick="switchMode('admin')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin</button>
      </div>
    </header>

    <div id="app"></div>
  </div>

<script>
/* ================= CONFIG ================= */
const GAS_BASE   = 'https://script.google.com/macros/s/AKfycbzc8m3R_sUQX3kDZEbYFYMwaNxrrju1VWkX6HGGCnUON9dR48p-woccIuddzk_8RxP_3g/exec';
const ADMIN_PASS = '6515';

/* -------------- Utils -------------- */
const fmtNum = n => Number(n||0).toLocaleString('th-TH');
const esc = s => String(s ?? '').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));

/* -------------- Data -------------- */
async function fetchOrders(){
  const url = `${GAS_BASE}?action=list&adminKey=${encodeURIComponent(ADMIN_PASS)}&callback=?`;
  // ‡πÉ‡∏ä‡πâ JSONP ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å GAS)
  return new Promise((resolve) => {
    const cbName = 'cb'+Math.random().toString(36).slice(2);
    window[cbName] = (res)=>{ delete window[cbName]; s.remove(); resolve(res||{}); };
    const s = document.createElement('script');
    s.src = url.replace('=?', '=' + cbName);
    document.body.appendChild(s);
  });
}

/* -------------- Render -------------- */
function renderApp(orders){
  const host = document.getElementById('app');
  if (!orders || !orders.ok) {
    host.innerHTML = `<div class="card"><div class="box">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div></div>`;
    return;
  }
  host.innerHTML = orders.data.map(renderOrderCard).join('');
}

function renderOrderCard(o){
  const qr = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(o.booking)}`;
  const shopPath = (o.fromShop||'-') + ' ‚Üí ' + (o.toShop||'-');

  const steps = [
    {key:'‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',    label:'‡∏à‡∏≠‡∏á',     icon:'üì¶'},
    {key:'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',  label:'‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°',  icon:'üß∞'},
    {key:'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',        label:'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',  icon:'üöö'},
    {key:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß',label:'‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô', icon:'üè™'},
    {key:'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',label:'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', icon:'‚úÖ'}
  ];
  const activeIdx = Math.max(0, steps.findIndex(s=>o.status && o.status.indexOf(s.key) >= 0));

  const rows = o.items.map(it => `
    <tr>
      <td class="mut">${esc(it.code)}</td>
      <td>${esc(it.desc)}</td>
      <td class="right">${fmtNum(it.price)}</td>
      <td class="right">${fmtNum(it.qty)}</td>
      <td class="right">${fmtNum(it.amount)}</td>
      <td class="mut">${esc(it.disc || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
      <td class="mut">${esc(it.discCode || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
      <td class="mut">${esc(it.discRule || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
    </tr>
  `).join('');

  return `
  <div class="card order-card" id="card-${esc(o.booking)}">
    <div class="head">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="qrcode" title="‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏à‡∏≠‡∏á"><img src="${qr}" alt="QR ${esc(o.booking)}"></div>
        <div>
          <div class="bno">Booking #${esc(o.booking)}</div>
          <div class="meta">
            <span class="chip">${esc(o.status || '-')}</span>
            <span class="mut">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${esc(o.statusAt || '-')}</span>
          </div>
        </div>
      </div>
      <div class="mut">${esc(shopPath)}</div>
    </div>

    <div class="box">
      <div class="cust">
        ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <b>${esc(o.customer.name)} ${esc(o.customer.last)}</b>
        <span style="margin-left:8px;color:#667">‚Ä¢</span>
        <a href="mailto:${esc(o.customer.email)}">${esc(o.customer.email)}</a>
        <span style="margin-left:8px;color:#667">‚Ä¢</span>
        ${esc(o.customer.tel)}
      </div>

      <div class="timeline">
        ${steps.map((s,idx)=>`
          <div class="step ${idx<=activeIdx?'active':''}">
            <div class="ico">${s.icon}</div>
            <div class="cap">${s.label}</div>
          </div>
        `).join('')}
      </div>

      <table>
        <thead>
          <tr>
            <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
            <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th class="right">‡∏£‡∏ß‡∏°</th>
            <th>PROMOTION %</th><th>PROMOTION CODE</th><th>CONDITION</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
            <td class="right">${fmtNum(o.total)}</td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
      </table>

      <div class="controls no-print">
        <select class="select" id="sel-${esc(o.booking)}">
          <option>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
          <option>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
          <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
        </select>
        <button class="btn pri" onclick="alert('‡πÄ‡∏î‡πÇ‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏î')">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>

        <button class="btn" data-format="thermal" data-booking="${esc(o.booking)}" onclick="handlePrintBtn(this)">
          ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á (Thermal)
        </button>
        <button class="btn" data-format="a4" data-booking="${esc(o.booking)}" onclick="handlePrintBtn(this)">
          ‡∏û‡∏¥‡∏°‡∏û‡πå A4
        </button>
      </div>
    </div>
  </div>`;
}

/* -------------- Print (A4 & Thermal) -------------- */
function handlePrintBtn(btn){
  const booking = btn.dataset.booking;
  const format  = (btn.dataset.format || 'a4').toLowerCase();
  printBooking(booking, format);
}

function printBooking(booking, format='a4'){
  const card = document.querySelector(`#card-${CSS.escape(booking)}`);
  if (!card) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ'); return; }

  // clone ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏ö‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå
  const clone = card.cloneNode(true);
  clone.querySelectorAll('.no-print, .controls').forEach(el => el.remove());
  clone.style.boxShadow = 'none';
  clone.style.border = '0';
  clone.style.margin = '0';
  clone.style.borderRadius = '0';

  // CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå
  const printCss = `
    *{box-sizing:border-box;font-family: Prompt, "TH Sarabun New", Arial, sans-serif}
    body{margin:0;padding:${format==='thermal' ? '8px' : '14px'}}
    .order-card{box-shadow:none;border:0;margin:0;padding:0}
    table{width:100%;border-collapse:collapse;font-size:${format==='thermal' ? '11pt' : '12pt'}}
    th,td{border:1px solid #bbb;padding:${format==='thermal' ? '4px 6px' : '6px 8px'}}
    tfoot td{font-weight:700}
    .qrcode{border:0}
    @media print{ .no-print{display:none!important} }
    ${format==='thermal'
      ? `@page{size:80mm auto;margin:0} body{width:80mm}`
      : `@page{size:A4;margin:12mm}`}
  `;

  const html = `
    <!doctype html>
    <html>
      <head>
        <meta charset="utf-8">
        <title>Booking #${esc(booking)}</title>
        <style>${printCss}</style>
      </head>
      <body>${clone.outerHTML}</body>
    </html>
  `;

  // ‡πÉ‡∏ä‡πâ iframe ‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á popup blocker
  const iframe = document.createElement('iframe');
  Object.assign(iframe.style, {
    position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0',visibility:'hidden'
  });
  document.body.appendChild(iframe);

  const w = iframe.contentWindow;
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();

  setTimeout(()=>{ try{ w.print(); } finally{ setTimeout(()=>iframe.remove(), 500); } }, 350);
}

/* -------------- Boot -------------- */
function switchMode(mode){
  // ‡πÄ‡∏î‡πÇ‡∏°: ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏â‡∏¢ ‡πÜ
  alert('‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î: ' + mode);
}
(async function(){
  const res = await fetchOrders();
  renderApp(res);
})();
</script>
</body>
</html>
