<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Toy City ‚Äì Order Portal</title>
<style>
  :root{--pri:#4f46e5;--mut:#6b7280;--bd:#e5e7eb;--bg:#f7f8ff}
  *{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,system-ui,-apple-system,Arial;background:var(--bg);color:#111}
  .wrap{max-width:1080px;margin:28px auto;padding:0 16px}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .tabs{display:flex;gap:10px}
  .tab{border:1px solid var(--bd);background:#fff;padding:9px 12px;border-radius:12px;cursor:pointer}
  .tab.active{background:var(--pri);color:#fff;border-color:var(--pri)}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 10px 24px #00000010;margin-top:14px}
  .hd{padding:14px 16px;border-bottom:1px solid var(--bd);font-weight:700}
  .bd{padding:16px}
  .muted{color:var(--mut)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .input{border:1px solid var(--bd);border-radius:10px;padding:10px 12px;min-width:240px}
  .btnP{background:var(--pri);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btnS{background:#fff;border:1px solid var(--bd);border-radius:10px;padding:10px 14px;cursor:pointer}
  .alert{padding:12px;border-radius:10px;margin-bottom:10px}
  .warn{background:#fff7ed;border:1px solid #fed7aa}
  .err{background:#fef2f2;border:1px solid #fecaca}
  .order{border:1px solid var(--bd);border-radius:12px;margin-top:12px;overflow:hidden}
  .order-hd{display:flex;justify-content:space-between;gap:10px;padding:12px 14px;background:#fafbff;border-bottom:1px solid var(--bd);flex-wrap:wrap}
  .badge{padding:6px 10px;border-radius:999px;font-size:13px;background:#eef2ff;color:#3730a3}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--bd);font-size:14px}
  th{background:#f3f4ff;text-align:left}
  .right{text-align:right}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <h2>üéÆ Toy City ‚Äì Order Portal</h2>
    <div class="tabs">
      <button id="tabC" class="tab active">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      <button id="tabA" class="tab">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin</button>
    </div>
  </div>

  <!-- CUSTOMER (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•) -->
  <div id="viewC" class="card">
    <div class="hd">üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á</div>
    <div class="bd">
      <div id="cGate" class="alert warn" style="display:none">
        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      </div>
      <div id="cOut" class="muted">‚Äî</div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="viewA" class="card" style="display:none">
    <div class="hd">üõ†Ô∏è Admin Console</div>
    <div class="bd">
      <!-- login row -->
      <div id="aLogin" class="row">
        <input id="aPass" class="input" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin"/>
        <button id="aGo" class="btnP">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
      <!-- toolbar -->
      <div id="aTools" class="row" style="display:none;margin-top:6px">
        <select id="fStatus" class="input">
          <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
          <option>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
          <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
        </select>
        <input id="fBooking" class="input" placeholder="‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏à‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 102380)"/>
        <input id="fFrom" class="input" placeholder="From Shop"/>
        <button id="btnReload" class="btnS">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
      <div id="aMsg" class="muted" style="margin-top:10px"></div>
      <div id="aResult" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxxziOyC5TfTekQJuS5Gf5zwHHkw548EPjHgW7ji4gTlNnFGtFXoLTaFRwIiNoLERVpTQ/exec'; // <‚Äî ‡πÉ‡∏™‡πà /exec ‡∏Ç‡∏≠‡∏á GAS

/* ================== Helpers ================== */
const qs = new URLSearchParams(location.search);
const BOOKING = qs.get('booking');
const TOKEN   = qs.get('token');
const $ = id => document.getElementById(id);
function show(el,on){ (typeof el==='string'?$(el):el).style.display=on?'block':'none'; }
function esc(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
async function apiGet(q){ const r=await fetch(WEB_APP_URL+'?'+q); return r.json(); }

/* ================== Tabs ================== */
$('tabC').onclick=()=>{ $('tabC').classList.add('active');$('tabA').classList.remove('active');show('viewC',true);show('viewA',false); };
$('tabA').onclick=()=>{ $('tabA').classList.add('active');$('tabC').classList.remove('active');show('viewC',false);show('viewA',true); };

/* ================== Customer ================== */
(function initCustomer(){
  if(!BOOKING || !TOKEN){ show('cGate',true); $('cOut').innerHTML=''; return; }
  $('cOut').innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á #${esc(BOOKING)} ‚Ä¶`;
  // (‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ booking+token ‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
})();

/* ================== Admin Login ================== */
let adminKey = sessionStorage.getItem('adminKey') || '';
const aLogin  = $('aLogin'), aTools = $('aTools'), aMsg = $('aMsg'), aRes = $('aResult');

async function tryLogin(pass){
  aMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‚Ä¶';
  try{
    const res = await apiGet('action=list&adminKey='+encodeURIComponent(pass));
    if(!res || !res.ok){ aMsg.textContent='‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'; return false; }
    adminKey = pass;
    sessionStorage.setItem('adminKey', pass);
    aMsg.textContent='‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì';
    aLogin.style.display='none';
    aTools.style.display='flex';
    await loadOrders();            // ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏≤‡πÄ‡∏ô‡∏• + ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    return true;
  }catch(e){
    aMsg.textContent='‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
    return false;
  }
}
$('aGo').onclick = ()=> {
  const pass = $('aPass').value.trim();
  if(!pass){ aMsg.textContent='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; return; }
  tryLogin(pass);
};

if (adminKey){ // auto-login ‡∏à‡∏≤‡∏Å sessionStorage
  tryLogin(adminKey);
}

/* ================== Admin ‚Äì list & render ================== */
$('btnReload').onclick = () => loadOrders();

async function loadOrders(){
  aRes.innerHTML = '<div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>';
  try{
    const res = await apiGet('action=list&adminKey='+encodeURIComponent(adminKey));
    if(!res.ok){ aRes.innerHTML = '<div class="alert err">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>'; return; }
    let data = res.data || [];
    // filters
    const fs = $('fStatus').value.trim();
    const fb = $('fBooking').value.trim();
    const ff = $('fFrom').value.trim();
    data = data.filter(o =>
      (!fs || o.status===fs) &&
      (!fb || String(o.booking).includes(fb)) &&
      (!ff || String(o.fromShop||'').toLowerCase().includes(ff.toLowerCase()))
    );
    if(!data.length){ aRes.innerHTML = '<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }
    aRes.innerHTML = data.map(o=>renderOrder(o,true)).join('');
  }catch(e){
    aRes.innerHTML = '<div class="alert err">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>';
  }
}

function renderOrder(o, withControls){
  const hasDisc     = o.items.some(it => (it.disc||'').toString().trim() !== '');
  const hasDiscCode = o.items.some(it => (it.discCode||'').toString().trim() !== '');
  const hasDiscRule = o.items.some(it => (it.discRule||'').toString().trim() !== '');

  const thead = `
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
      <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
      <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
      <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th class="right">‡∏£‡∏ß‡∏°</th>
      ${hasDisc?'<th>PROMOTION %</th>':''}
      ${hasDiscCode?'<th>PROMOTION CODE</th>':''}
      ${hasDiscRule?'<th>CONDITION</th>':''}
    </tr>`;

  const tbody = o.items.map(it=>`
    <tr>
      <td>${esc(it.code||'-')}</td>
      <td>${esc(it.desc||'-')}</td>
      <td class="right">${Number(it.price||0).toLocaleString('th-TH')}</td>
      <td class="right">${Number(it.qty||0).toLocaleString('th-TH')}</td>
      <td class="right">${Number(it.amount||0).toLocaleString('th-TH')}</td>
      ${hasDisc?`<td>${esc((it.disc||'‡πÑ‡∏°‡πà‡∏°‡∏µ').toString().replace(/^0\.\d+$/,(m)=>Math.round(parseFloat(m)*100)+'%'))}</td>`:''}
      ${hasDiscCode?`<td>${esc(it.discCode||'‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>`:''}
      ${hasDiscRule?`<td>${esc(it.discRule||'‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>`:''}
    </tr>`).join('');

  const controls = withControls ? `
    <div class="row" style="margin-top:12px">
      <select id="st-${o.booking}" class="input">
        <option ${o.status==='‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'?'selected':''}>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option ${o.status.startsWith('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')?'selected':''}>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
        <option ${o.status==='‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
        <option ${o.status==='‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'?'selected':''}>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
      </select>
      <button class="btnP" onclick="updateStatus('${o.booking}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
    </div>` : '';

  return `
  <div class="order">
    <div class="order-hd">
      <div><b>üìã Booking #${esc(o.booking)}</b> ¬∑ <span class="badge">${esc(o.status)}</span></div>
      <div class="muted">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô: ${esc(o.fromShop||'-')} ‚Üí ${esc(o.toShop||'-')} ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${esc(o.statusAt||'-')}</div>
    </div>
    <div class="bd">
      <table>
        <thead>${thead}</thead>
        <tbody>${tbody}</tbody>
        <tfoot>
          <tr>
            <td colspan="${5 + (hasDisc?1:0) + (hasDiscCode?1:0) + (hasDiscRule?1:0)}" class="right"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></td>
            <td class="right"><b>${Number(o.total||0).toLocaleString('th-TH')} ‡∏ö‡∏≤‡∏ó</b></td>
          </tr>
        </tfoot>
      </table>
      ${controls}
    </div>
  </div>`;
}

async function updateStatus(booking){
  const st = document.getElementById('st-'+booking).value;
  try{
    const res = await apiGet(`action=update&adminKey=${encodeURIComponent(adminKey)}&booking=${encodeURIComponent(booking)}&status=${encodeURIComponent(st)}`);
    if(res && res.ok){ alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)'); loadOrders(); }
    else{ alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
  }catch(e){ alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
}

/* ‡πÄ‡∏õ‡∏¥‡∏î‡∏û‡∏≤‡πÄ‡∏ô‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡πÉ‡∏™‡πà ?admin=1 ‡∏´‡∏£‡∏∑‡∏≠ #admin */
if (location.search.includes('admin=1') || location.hash.toLowerCase()==='#admin'){ $('tabA').click(); }
</script>
</body>
</html>
