<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Toy City ‚Äì Order Portal</title>
<style>
  :root { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto; }
  body { margin:0; background:#0b2545; color:#fff; }
  .nav { display:flex; gap:12px; align-items:center; padding:14px 20px; background:#0f2f5f; position:sticky; top:0; z-index:10; box-shadow:0 6px 16px rgba(0,0,0,.25); }
  .nav h1 { margin:0; font-size:18px; font-weight:800; }
  .spacer{flex:1}
  .btn{ padding:10px 14px; border:0; border-radius:12px; background:#1e72ff; color:#fff; cursor:pointer; font-weight:700; }
  .btn.ghost{ background:#1b3c7a; }
  .btn.min{ padding:8px 10px; border-radius:10px; }
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .wrap{ max-width:1100px; margin:0 auto; padding:22px; }
  .card{ background:#0f2f5f; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
  .hide{ display:none }
  .muted{ opacity:.8; font-size:13px; }
  label{ display:block; font-size:13px; margin:10px 0 6px; }
  input{ width:100%; padding:12px 14px; border-radius:10px; border:none; outline:none; background:#11376f; color:#fff; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  table{ width:100%; border-collapse:separate; border-spacing:0 8px; }
  th,td{ text-align:left; padding:8px 10px; }
  th{ font-size:12px; opacity:.8 }
  .order{ background:#0c2a56; border-radius:14px; padding:14px; margin-top:12px; }
  .order h4{ margin:0; font-size:15px; }
  .meta{ font-size:12px; opacity:.85 }
  .right{text-align:right}
  .ok{ color:#9cf5bf } .err{ color:#ffb3b3 }
  .badge{ background:#5b48d9; color:#fff; padding:4px 8px; border-radius:999px; font-size:12px; }
</style>
</head>
<body>
  <div class="nav">
    <h1>üß© Toy City ‚Äì Order Portal</h1>
    <div class="spacer"></div>
    <button id="btnOpenForm" class="btn">‡∏ß‡∏≤‡∏á ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    <button id="btnTabAdmin" class="btn ghost">Admin</button>
  </div>

  <div class="wrap">
    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô -->
    <section id="secForm" class="card hide">
      <h2 style="margin:0 0 6px;">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <div class="muted">OrderDate ‡∏à‡∏∞‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B)</div>

      <div class="grid2 mt12">
        <div><label>‡∏ä‡∏∑‡πà‡∏≠ (F)</label><input id="firstName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢"></div>
        <div><label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (G)</label><input id="lastName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏à‡∏î‡∏µ"></div>
        <div><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (H)</label><input id="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678"></div>
        <div><label>Email (E)</label><input id="email" type="email" placeholder="you@example.com"></div>
      </div>

      <div class="mt16">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="muted">‡πÉ‡∏™‡πà ‚ÄúCode / ‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‚Äù (I, K, L)</div>
          <button class="btn min" id="btnAddItem">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <table class="mt12">
          <thead>
            <tr><th>Code ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (I)</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤ (K)</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (L)</th><th class="right">‡∏•‡∏ö</th></tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>

      <div class="mt16" style="display:flex;gap:10px;align-items:center;">
        <button class="btn" id="btnSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <span id="state" class="muted">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
      </div>
      <div id="result" class="mt12"></div>
      <div class="muted mt12">* ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <b>J/N/O/P/Q/R</b> ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</div>
    </section>

    <!-- Admin -->
    <section id="secAdmin" class="card mt16">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <h2 style="margin:0;">Admin Console</h2>
        <span class="badge" id="lStatus">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
        <div class="spacer"></div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="adminPass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin" style="width:220px;" autocomplete="current-password">
          <button class="btn min ghost" id="togglePass">‡πÅ‡∏™‡∏î‡∏á</button>
        </div>
      </div>

      <div class="grid2 mt12">
        <div><label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏£‡∏´‡∏±‡∏™/‡∏ä‡∏∑‡πà‡∏≠/‡∏≠‡∏µ‡πÄ‡∏°‡∏•/‡πÇ‡∏ó‡∏£)</label><input id="search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä"></div>
        <div style="display:flex;align-items:flex-end;gap:8px;">
          <button class="btn" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button class="btn ghost" id="btnClear">‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
      </div>
      <div id="orders" class="mt16"></div>
    </section>
  </div>

<!-- ***************** JS ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏±‡∏î‡∏ó‡∏¥‡πâ‡∏á) ***************** -->
<script>
'use strict';

// 1) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL GAS (‡∏•‡∏¥‡∏á‡∏Å‡πå /exec ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
const GAS_EXEC_URL = 'https://script.google.com/macros/s/AKfycby9kitmsDUTeNfb7LSVXV_wDLt58Y8aQtP2G0KG-ExS--2oWPTaeUmgod_7zvCwY_WpFw/exec';

// 2) ‡∏≠‡πÅ‡∏î‡∏õ‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GAS: ‡πÉ‡∏ä‡πâ google.script.run ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ô‡πÉ‡∏ô Apps Script; ‡∏ô‡∏≠‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏•‡∏≠‡∏á fetch ‡πÅ‡∏•‡πâ‡∏ß fallback JSONP
async function callAPI(apiName, payload = {}) {
  if (window.google && google.script && google.script.run) {
    return new Promise((resolve, reject) => {
      google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[apiName](payload);
    });
  }
  try {
    const r = await fetch(GAS_EXEC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ api: apiName, payload })
    });
    return await r.json();
  } catch (e) {
    return callAPI_JSONP(apiName, payload); // fallback CORS
  }
}
function callAPI_JSONP(apiName, payload = {}) {
  return new Promise((resolve, reject) => {
    const cb = '__jsonp_cb_' + Math.random().toString(36).slice(2);
    window[cb] = (data) => { try { resolve(data); } finally { cleanup(); } };
    function cleanup(){ delete window[cb]; if (s && s.parentNode) s.parentNode.removeChild(s); }
    const url = GAS_EXEC_URL
      + '?api=' + encodeURIComponent(apiName)
      + '&payload=' + encodeURIComponent(JSON.stringify(payload))
      + '&callback=' + encodeURIComponent(cb);
    const s = document.createElement('script');
    s.src = url; s.onerror = () => { cleanup(); reject(new Error('JSONP failed')); };
    document.head.appendChild(s);
  });
}

// 3) Utils / elements
const $ = (id) => document.getElementById(id);
const fmt = new Intl.NumberFormat('th-TH', { maximumFractionDigits: 2 });

const secForm = $('secForm'), secAdmin = $('secAdmin');
const btnOpenForm = $('btnOpenForm'), btnTabAdmin = $('btnTabAdmin');
const btnAddItem = $('btnAddItem'), btnSubmit = $('btnSubmit');
const itemsBody = $('itemsBody'), result = $('result'), state = $('state');
const firstName = $('firstName'), lastName = $('lastName'), phone = $('phone'), email = $('email');

const lStatus = $('lStatus'), adminPass = $('adminPass'), togglePass = $('togglePass');
const btnRefresh = $('btnRefresh'), btnClear = $('btnClear'), search = $('search'), ordersBox = $('orders');

// 4) UI handlers
togglePass.onclick = () => { const isPw = adminPass.type === 'password'; adminPass.type = isPw ? 'text' : 'password'; togglePass.textContent = isPw ? '‡∏ã‡πà‡∏≠‡∏ô' : '‡πÅ‡∏™‡∏î‡∏á'; };
btnOpenForm.onclick = () => { secForm.classList.toggle('hide'); if (!secForm.classList.contains('hide') && itemsBody.children.length === 0) addItemRow(); if (!secForm.classList.contains('hide')) secForm.scrollIntoView({behavior:'smooth'}); };
btnTabAdmin.onclick = () => { secAdmin.scrollIntoView({behavior:'smooth'}); };

function addItemRow() {
  const tr = document.createElement('tr');
  tr.innerHTML = '<td><input class="code" placeholder="‡πÄ‡∏ä‡πà‡∏ô 4611127"></td>'
               + '<td><input class="price" type="number" step="0.01" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2520"></td>'
               + '<td><input class="qty" type="number" step="1" min="0" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1"></td>'
               + '<td class="right"><button class="btn min ghost del">‡∏•‡∏ö</button></td>';
  tr.querySelector('.del').onclick = () => tr.remove();
  itemsBody.appendChild(tr);
}
btnAddItem.onclick = addItemRow;

// 5) Submit form
btnSubmit.onclick = async () => {
  const payload = {
    firstName: (firstName.value || '').trim(),
    lastName : (lastName.value || '').trim(),
    phone    : (phone.value || '').trim(),
    email    : (email.value || '').trim(),
    items    : []
  };
  [...itemsBody.querySelectorAll('tr')].forEach(tr => {
    const code  = tr.querySelector('.code').value.trim();
    const price = parseFloat(tr.querySelector('.price').value || '0');
    const qty   = parseInt(tr.querySelector('.qty').value || '0', 10);
    if (code || price || qty) payload.items.push({ code, price, qty });
  });

  if (payload.items.length === 0) {
    result.innerHTML = '<div class="err">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>'; return;
  }

  try {
    btnSubmit.disabled = true; state.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; result.textContent = '';
    const res = await callAPI('saveOrders', payload);
    if (!res || !res.ok) throw new Error(res?.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    result.innerHTML = `<div class="ok">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${res.count} ‡πÅ‡∏ñ‡∏ß ‚Ä¢ ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${res.firstRow}‚Äì${res.lastRow}</div>`;
    state.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
    itemsBody.innerHTML = ''; addItemRow();
  } catch (err) {
    result.innerHTML = `<div class="err">‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message || err}</div>`;
    state.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
  } finally {
    btnSubmit.disabled = false;
  }
};

// 6) Admin list
function renderOrders(items) {
  if (!items || items.length === 0) { ordersBox.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>'; return; }
  ordersBox.innerHTML = items.map(x => (
    '<div class="order">'
    + `<div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;"><h4>‡∏£‡∏´‡∏±‡∏™: <b>${x.code || '-'}</b></h4><div class="meta">‡πÅ‡∏ñ‡∏ß: ${x.row} ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${x.orderDate || '-'}</div></div>`
    + `<div class="meta mt8">üë§ ${x.firstName || ''} ${x.lastName || ''} ‚Ä¢ ‚úâÔ∏è ${x.email || '-'} ‚Ä¢ üìû ${x.phone || '-'}</div>`
    + `<div class="meta mt8">‡∏£‡∏≤‡∏Ñ‡∏≤: ${fmt.format(x.price || 0)} ‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${fmt.format(x.qty || 0)}</div>`
    + '</div>'
  )).join('');
}
async function refreshOrders(){
  try {
    lStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    const res = await callAPI('getOrders', { limit: 50, q: (search.value || '') });
    if (!res?.ok) throw new Error(res?.error || '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    renderOrders(res.items || []);
    lStatus.textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏£‡∏ß‡∏° ${res.total || 0})`;
  } catch (err) {
    lStatus.textContent = '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
    ordersBox.innerHTML = `<div class="err">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message || err}</div>`;
  }
}
btnRefresh.onclick = refreshOrders;
btnClear.onclick = () => { search.value=''; refreshOrders(); };

// 7) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
document.addEventListener('DOMContentLoaded', () => { addItemRow(); refreshOrders(); });
</script>
<!-- ***************** JS ‡∏à‡∏ö ***************** -->
</body>
</html>
