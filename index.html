<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Toy City ‚Äì Order Portal</title>
<style>
  :root{
    --pri:#5b61ff; --pri2:#7749f8; --bg:#f6f7fb; --mut:#667085; --ok:#14a44d; --err:#e11d48;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:18px 20px;background:#fff;box-shadow:0 2px 8px rgba(16,24,40,.06)}
  .brand{font-size:20px;font-weight:700}
  .tabs{display:flex;gap:10px}
  .tabbtn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
  .tabbtn.active{background:var(--pri);color:#fff;border-color:transparent}
  main{max-width:1000px;margin:24px auto;padding:0 14px}
  .card{background:#fff;border-radius:14px;box-shadow:0 8px 24px rgba(16,24,40,.06);padding:16px 18px;margin-bottom:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .filter{height:40px;border:1px solid #e5e7eb;border-radius:10px;padding:0 12px;background:#fff}
  .btn{background:var(--pri);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.secondary{background:#f1f5ff;color:#374151;border:1px solid #e5e7eb}
  .btn.ok{background:var(--ok)}
  .btn.err{background:var(--err)}
  .alert{padding:10px 12px;border-radius:8px;background:#eef2ff;color:#3730a3}
  .alert.error{background:#fde2e4;color:#9b1c1c}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #eef2f7;padding:10px 8px;font-size:14px;vertical-align:top}
  th{background:linear-gradient(180deg,#6b7cff,#4f46e5);color:#fff;position:sticky;top:0}
  td.num{text-align:right}
  .order-card{border:1px solid #eef2f7;border-radius:12px;padding:12px;margin:12px 0}
  .mut{color:var(--mut);font-size:13px}
  .pill{display:inline-block;padding:4px 8px;border-radius:99px;background:#ebf1ff;color:#223}
</style>
</head>
<body>
<header>
  <div class="brand">üéÆ Toy City ‚Äì Order Portal</div>
  <div class="tabs">
    <button id="tabC" class="tabbtn active" onclick="switchTab('c')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
    <button id="tabA" class="tabbtn" onclick="switchTab('a')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin</button>
  </div>
</header>

<main>
  <!-- CUSTOMER -->
  <section id="secC" class="card">
    <h3>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á</h3>
    <div class="mut">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
    <div id="c-result" style="margin-top:12px"></div>
  </section>

  <!-- ADMIN -->
  <section id="secA" class="card" style="display:none">
    <h3>üëë Admin Console</h3>

    <div id="a-login" class="row" style="margin:10px 0 14px">
      <input id="a-pass" class="filter" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin" />
      <button class="btn" onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div id="a-panel" style="display:none">
      <div class="row" style="margin-bottom:8px">
        <select id="filter-status" class="filter">
          <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
          <option>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
          <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
        </select>
        <input id="filter-booking" class="filter" placeholder="‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏à‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 102380)" />
        <select id="filter-shop" class="filter"><option value="">From Shop: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
        <button class="btn secondary" onclick="loadOrders()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>

      <div id="a-result" class="card" style="padding:0;border:none;box-shadow:none"></div>
    </div>
  </section>
</main>

<script>
/* ====== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á GAS Web App (‚Ä¶/exec) ====== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzc8m3R_sUQX3kDZEbYFYMwaNxrrju1VWkX6HGGCnUON9dR48p-woccIuddzk_8RxP_3g/exec'; // <<< ‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

/* ====== Utils ====== */
function switchTab(t){
  const c = document.getElementById('secC'), a = document.getElementById('secA');
  document.getElementById('tabC').classList.toggle('active', t==='c');
  document.getElementById('tabA').classList.toggle('active', t==='a');
  c.style.display = (t==='c')?'block':'none';
  a.style.display = (t==='a')?'block':'none';
}
function fmtNum(n){ return Number(n||0).toLocaleString('th-TH'); }
function fmtDate(d){ try{return new Date(d).toLocaleString('th-TH')}catch(e){return d} }
function fmtDiscPercent(v){
  const s = String(v ?? '').trim();
  if (!s) return '‡πÑ‡∏°‡πà‡∏°‡∏µ';
  const m = s.match(/(\d+(?:\.\d+)?)\s*%/); if (m) return `${parseFloat(m[1])}%`;
  const n = parseFloat(s); if (isNaN(n)) return s;
  const pct = n>1 ? n : n*100;
  return `${(+pct).toString().replace(/\.0+$/,'')}%`;
}
function apiJSONP(params){
  const url = new URL(WEB_APP_URL);
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
  const cb = '__cb' + Math.random().toString(36).slice(2);
  url.searchParams.set('callback', cb);
  return new Promise((resolve,reject)=>{
    window[cb] = (data)=>{ resolve(data); cleanup(); };
    const s = document.createElement('script');
    s.src = url.toString(); s.onerror=()=>{ reject(new Error('JSONP error')); cleanup(); };
    document.body.appendChild(s);
    function cleanup(){ delete window[cb]; s.remove(); }
  });
}

/* ====== CUSTOMER: auto-open by token ====== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const u = new URL(location.href);
  const booking = u.searchParams.get('booking');
  const token   = u.searchParams.get('token');
  const c = document.getElementById('c-result');
  if (booking && token){
    c.innerHTML = `<div class="alert">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á #${booking} ...</div>`;
    try{
      const res = await apiJSONP({ action:'order', booking, token });
      if(!res.ok || !res.data){ c.innerHTML = '<div class="alert error">‚ùå ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>'; return; }
      c.innerHTML = renderOrder(res.data,false);
    }catch(e){
      c.innerHTML = '<div class="alert error">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
    }
  }
});

/* ====== ADMIN ====== */
let ADMIN_KEY = '';
let __ORDERS__ = [];

async function adminLogin(){
  const pass = document.getElementById('a-pass').value.trim();
  if (pass !== '6515'){ alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
  ADMIN_KEY = pass;
  document.getElementById('a-login').style.display='none';
  document.getElementById('a-panel').style.display='block';
  await loadOrders();
}
async function loadOrders(){
  const box = document.getElementById('a-result');
  box.innerHTML = '<div class="alert">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
  try{
    const res = await apiJSONP({ action:'list', adminKey:ADMIN_KEY });
    if(!res.ok){ box.innerHTML = '<div class="alert error">‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>'; return; }
    __ORDERS__ = res.data || [];
    populateFromShopFilter(__ORDERS__);
    applyAdminFilters();
  }catch(e){
    box.innerHTML = '<div class="alert error">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
  }
}
function unique(arr){ return [...new Set(arr.filter(Boolean))]; }
function populateFromShopFilter(orders){
  const sel = document.getElementById('filter-shop');
  const shops = unique(orders.map(o=>o.fromShop));
  sel.innerHTML = `<option value="">From Shop: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` + shops.map(s=>`<option>${s}</option>`).join('');
  sel.onchange = applyAdminFilters;
}
function applyAdminFilters(){
  const st   = document.getElementById('filter-status').value.trim();
  const bq   = document.getElementById('filter-booking').value.trim();
  const shop = document.getElementById('filter-shop').value.trim();
  const box  = document.getElementById('a-result');
  const list = __ORDERS__.filter(o=>{
    if (st && o.status !== st) return false;
    if (shop && o.fromShop !== shop) return false;
    if (bq && !String(o.booking).includes(bq)) return false;
    return true;
  });
  box.innerHTML = list.map(o=>renderOrder(o,true)).join('') || '<div class="alert">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
}

function renderOrder(o, includeControls){
  const rows = o.items.map(it=>`
    <tr>
      <td>${it.code}</td>
      <td>${it.desc}</td>
      <td class="num">${fmtNum(it.price)}</td>
      <td class="num">${fmtNum(it.qty)}</td>
      <td class="num">${fmtNum(it.amountNet ?? it.amount)}</td>
      <td>${fmtDiscPercent(it.disc)}</td>
      <td>${it.discCode || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
      <td>${it.discRule || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
    </tr>`).join('');

  const head = `
    <div class="row" style="justify-content:space-between">
      <div><b>Booking #${o.booking}</b>
        <span class="pill">${o.status}</span>
      </div>
      <div class="mut">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô: ${o.fromShop || '-'} ‚Üí ${o.toShop || '-'}</div>
    </div>
    <div class="mut">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${o.statusAt || '-'}</div>`;

  const table = `
    <table>
      <thead>
        <tr>
          <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th>‡∏£‡∏ß‡∏°</th><th>PROMOTION %</th><th>PROMOTION CODE</th><th>CONDITION</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
      <tfoot><tr><td colspan="4" class="num"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></td><td class="num"><b>${fmtNum(o.total)}</b></td><td colspan="3"></td></tr></tfoot>
    </table>`;

  const ctrl = includeControls ? `
    <div class="row" style="gap:10px;margin-top:10px">
      <select id="st-${o.booking}" class="filter">
        <option ${o.status==='‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' ? 'selected':''}>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option ${o.status==='‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)' ? 'selected':''}>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
        <option ${o.status==='‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß' ? 'selected':''}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
        <option ${o.status==='‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' ? 'selected':''}>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
      </select>
      <button class="btn" onclick="updateStatus('${o.booking}')">üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
      <button class="btn secondary" onclick="printOrder('${o.booking}','thermal')">üßæ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á (Thermal)</button>
      <button class="btn secondary" onclick="printOrder('${o.booking}','a4')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå A4</button>
    </div>` : '';

  return `<div class="order-card" data-booking="${o.booking}">${head}${table}${ctrl}</div>`;
}

async function updateStatus(booking){
  const st = document.getElementById('st-'+booking).value;
  const box = document.querySelector(`.order-card[data-booking="${booking}"]`);
  const info = document.createElement('div');
  info.className='mut'; info.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...'; box.appendChild(info);
  try{
    const res = await apiJSONP({ action:'update', adminKey:ADMIN_KEY, booking, status:st });
    info.remove();
    if(!res.ok){ alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); return; }
    await loadOrders();
  }catch(e){ info.remove(); alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
}

function printOrder(booking, mode){
  const src = document.querySelector(`.order-card[data-booking="${booking}"]`);
  const w = window.open('', '_blank');
  w.document.write(`
    <html><head><title>Print #${booking}</title>
    <style>body{font-family:system-ui,Arial;padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #ddd;padding:6px}
    </style></head><body>${src.outerHTML}</body></html>`);
  w.document.close(); w.focus(); w.print();
}
</script>
</body>
</html>
