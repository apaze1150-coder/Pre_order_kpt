<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Toy City ‚Äì Order Portal</title>
<style>
  :root{
    --bg:#f5f7ff; --card:#fff; --primary:#4f46e5; --muted:#6b7280;
    --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --line:#e5e7eb;
  }
  body{margin:0;background:linear-gradient(180deg,#5b67d9 0%,#7c62d9 60%,#885fd7 100%);
       font-family:Segoe UI,system-ui,-apple-system,Arial;color:#111}
  .wrap{max-width:1060px;margin:26px auto;padding:0 16px}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;color:#fff}
  .tabs{display:flex;gap:8px}
  .btn{background:#fff1;border:1px solid #ffffff40;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.active{background:#fff;color:#111}
  .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px #0002;margin-top:14px}
  .card .hd{padding:16px 18px;border-bottom:1px solid var(--line);font-weight:700}
  .card .bd{padding:18px}
  .muted{color:var(--muted)}
  .alert{padding:12px 14px;border-radius:10px}
  .alert.warn{background:#fff7ed;border:1px solid #fed7aa}
  .alert.err{background:#fef2f2;border:1px solid #fecaca}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  thead th{background:#eef2ff;color:#374151;text-align:left;padding:10px;border-bottom:1px solid var(--line)}
  td{padding:10px;border-bottom:1px solid var(--line)}
  td[align="right"]{text-align:right}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .input,select{border:1px solid var(--line);border-radius:10px;padding:10px 12px}
  .btnP{background:var(--primary);color:#fff;border:none}
  .badge{background:#10b98120;color:#065f46;border:1px solid #10b98155;border-radius:999px;padding:4px 10px;font-size:12px}
  .order{border:1px solid var(--line);border-radius:12px;margin-top:12px;overflow:hidden}
  .order-hd{padding:12px 14px;background:#f9fafb;display:flex;justify-content:space-between;align-items:center}
  .order-sub{color:var(--muted);font-size:13px;padding:0 14px 12px}
  .order-bd{padding:0 14px 14px}
  .foot{background:#f9fafb;padding:10px 14px;text-align:right;font-weight:700}
  /* timeline */
  .timeline{position:relative;padding-left:28px;margin:12px 0}
  .timeline::before{content:'';position:absolute;left:12px;top:0;bottom:0;width:4px;background:#e2e8f0;border-radius:2px}
  .tl-item{position:relative;margin:10px 0;padding-left:12px}
  .tl-dot{position:absolute;left:-2px;top:2px;width:16px;height:16px;border-radius:50%;background:#667eea;box-shadow:0 0 0 3px #eef2ff inset}
  .tl-icon{position:absolute;left:-1px;top:-1px;font-size:14px;line-height:16px;width:16px;height:16px;color:#fff;text-align:center}
  .tl-title{font-weight:700}
  .tl-time{color:var(--muted);font-size:12px}
  .flex-end{display:flex;gap:8px;justify-content:flex-end;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h2>üéÆ Toy City ‚Äì Order Portal</h2>
      <div class="tabs">
        <button id="tabBtnC" class="btn active">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
        <button id="tabBtnA" class="btn">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin</button>
      </div>
    </div>

    <!-- ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
    <div id="tabCustomer" class="card">
      <div class="hd">üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á</div>
      <div class="bd">
        <div id="c-gate" class="alert warn" style="display:none">
          ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        </div>
        <div id="c-result" class="muted">‚Äî</div>
      </div>
    </div>

    <!-- Admin -->
    <div id="tabAdmin" class="card" style="display:none">
      <div class="hd">üõ†Ô∏è Admin Console</div>
      <div class="bd" id="a-body">
        <div id="a-login" class="row">
          <input id="a-pass" class="input" type="password" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6515)"/>
          <button id="a-go" class="btnP input">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <div id="a-panel" style="display:none">
          <div class="row" style="margin-bottom:10px">
            <select id="f-status" class="input">
              <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
              <option>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
              <option>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
              <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
            </select>
            <input id="f-booking" class="input" placeholder="‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏à‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 102380)"/>
            <input id="f-from" class="input" placeholder="From Shop"/>
            <button id="a-refresh" class="btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
          <div id="a-result">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ===== ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ===== **/
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxxziOyC5TfTekQJuS5Gf5zwHHkw548EPjHgW7ji4gTlNnFGtFXoLTaFRwIiNoLERVpTQ/exec'; // <‚Äî URL /exec ‡∏Ç‡∏≠‡∏á GAS

/** ===== Utils ===== **/
const qs  = new URLSearchParams(location.search);
const BOOKING = qs.get('booking');
const TOKEN   = qs.get('token');

function esc(s){return String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
function num(n){return Number(n||0).toLocaleString('th-TH');}
function err(m){return `<div class="alert err">‚ùå ${m}</div>`;}
async function j(url){ const r = await fetch(url); return r.json(); }
function discToText(v){
  const s = String(v==null?'':v).trim();
  if(!s) return '';
  if(/%$/.test(s)) return s;
  const n = parseFloat(s);
  if(isNaN(n)) return s;
  return (n>1?n:n*100)+'%'; // 0.8 -> 80%
}
function iconOf(status){
  if(!status) return '‚Ä¢';
  if(status.includes('‡∏à‡∏≠‡∏á')) return 'üìù';
  if(status.includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á')) return 'üöö';
  if(status.includes('‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô')) return 'üè¨';
  if(status.includes('‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) return '‚úÖ';
  return '‚Ä¢';
}

/** ===== Tabs ===== **/
const tabBtnC=document.getElementById('tabBtnC');
const tabBtnA=document.getElementById('tabBtnA');
const tabC   =document.getElementById('tabCustomer');
const tabA   =document.getElementById('tabAdmin');
tabBtnC.onclick=()=>{tabBtnC.classList.add('active');tabBtnA.classList.remove('active');tabC.style.display='block';tabA.style.display='none';}
tabBtnA.onclick=()=>{tabBtnA.classList.add('active');tabBtnC.classList.remove('active');tabA.style.display='block';tabC.style.display='none';}

/** ===== Customer flow (secure link) ===== **/
(async function initCustomer(){
  const gate=document.getElementById('c-gate');
  const out =document.getElementById('c-result');

  if(!BOOKING || !TOKEN){
    gate.style.display='block';
    out.innerHTML='';
    return;
  }
  try{
    const order = await j(`${WEB_APP_URL}?action=order&booking=${encodeURIComponent(BOOKING)}&token=${encodeURIComponent(TOKEN)}`);
    if(!order.ok || !order.data){ out.innerHTML=err('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á'); return; }
    const tl = await j(`${WEB_APP_URL}?action=timeline&booking=${encodeURIComponent(BOOKING)}&token=${encodeURIComponent(TOKEN)}`);
    renderCustomer(order.data, tl.ok?tl.data:[]);
  }catch(e){ out.innerHTML=err('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
})();

function renderCustomer(o, timeline){
  const c=document.getElementById('c-result');
  const hasDisc = o.items.some(it => (it.disc||'').trim());

  const th = `
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏£‡∏ß‡∏° (‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î)</th>
      ${hasDisc?'<th>PROMOTION %</th><th>PROMOTION CODE</th><th>CONDITION</th>':''}
    </tr>`;
  const rows = o.items.map(it=>`
    <tr>
      <td>${esc(it.code)}</td>
      <td>${esc(it.desc)}</td>
      <td align="right">${num(it.price)}</td>
      <td align="right">${num(it.qty)}</td>
      <td align="right">${num(it.amountNet ?? it.amount)}</td>
      ${hasDisc?`
        <td>${esc(discToText(it.disc) || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
        <td>${esc(it.discCode || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
        <td>${esc(it.discRule || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>`:''}
    </tr>`).join('');

  const tlHtml = (timeline||[]).map(s=>`
    <div class="tl-item">
      <div class="tl-dot"></div>
      <div class="tl-icon">${iconOf(s.status)}</div>
      <div class="tl-title">${esc(s.status)}</div>
      <div class="tl-time">${esc(s.when)}</div>
    </div>`).join('');

  c.innerHTML=`
  <div class="order">
    <div class="order-hd">
      <div>üìã Booking #${o.booking}</div>
      <div class="badge">${esc(o.status)}</div>
    </div>
    <div class="order-sub">üë§ ${esc(o.customer.name)} ${esc(o.customer.last)} ¬∑ üìß ${esc(o.customer.email)} ¬∑ üìû ${esc(o.customer.tel)}<br>
      ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ${esc(o.fromShop||'-')} ‚Üí ${esc(o.toShop||'-')}
    </div>
    <div class="order-bd">
      <div class="timeline">${tlHtml}</div>
      <table>
        <thead>${th}</thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr><td colspan="${hasDisc?5:4}" align="right"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></td>
              <td align="right"><b>${num(o.total)} ‡∏ö‡∏≤‡∏ó</b></td>${hasDisc?'<td colspan="2"></td>':''}
          </tr>
        </tfoot>
      </table>
    </div>
  </div>`;
}

/** ===== Admin flow ===== **/
const aPanel = document.getElementById('a-panel');
const aPass  = document.getElementById('a-pass');
document.getElementById('a-go').onclick = ()=>{
  const key = aPass.value.trim();
  if(!key){ alert('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }
  sessionStorage.setItem('adminKey', key);
  aPanel.style.display='block';
  loadAdmin();
};

document.getElementById('a-refresh').onclick = ()=> loadAdmin();

async function loadAdmin(){
  const key = sessionStorage.getItem('adminKey') || '';
  const box = document.getElementById('a-result');
  try{
    const res = await j(`${WEB_APP_URL}?action=list&adminKey=${encodeURIComponent(key)}`);
    if(!res.ok){ box.innerHTML = err('‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
    renderAdmin(res.data);
  }catch(e){ box.innerHTML = err('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');}
}

function renderAdmin(list){
  const fStatus  = document.getElementById('f-status').value.trim();
  const fBooking = document.getElementById('f-booking').value.trim();
  const fFrom    = document.getElementById('f-from').value.trim().toLowerCase();

  const data = (list||[]).filter(o=>{
    if (fStatus && o.status!==fStatus) return false;
    if (fBooking && String(o.booking)!==fBooking) return false;
    if (fFrom && String(o.fromShop||'').toLowerCase()!==fFrom) return false;
    return true;
  });

  const html = data.map(o=>{
    const hasDisc = o.items.some(it => (it.disc||'').trim());
    const th = `
      <tr>
        <th>‡∏£‡∏´‡∏±‡∏™</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
        <th>‡∏£‡∏ß‡∏° (‡∏´‡∏•‡∏±‡∏á‡∏•‡∏î)</th>
        ${hasDisc?'<th>PROMOTION %</th><th>PROMOTION CODE</th><th>CONDITION</th>':''}
      </tr>`;
    const rows = o.items.map(it=>`
      <tr>
        <td>${esc(it.code)}</td>
        <td>${esc(it.desc)}</td>
        <td align="right">${num(it.price)}</td>
        <td align="right">${num(it.qty)}</td>
        <td align="right">${num(it.amountNet ?? it.amount)}</td>
        ${hasDisc?`
          <td>${esc(discToText(it.disc) || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
          <td>${esc(it.discCode || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>
          <td>${esc(it.discRule || '‡πÑ‡∏°‡πà‡∏°‡∏µ')}</td>`:''}
      </tr>`).join('');

    // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    const opts = ['‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)','‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß','‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢']
      .map(s=>`<option ${s===o.status?'selected':''}>${s}</option>`).join('');

    return `
    <div class="order">
      <div class="order-hd">
        <div>üìã Booking #${o.booking}</div>
        <div class="badge">${esc(o.status)}</div>
      </div>
      <div class="order-sub">üë§ ${esc(o.customer.name)} ${esc(o.customer.last)} ¬∑ üìß ${esc(o.customer.email)} ¬∑ üìû ${esc(o.customer.tel)}<br>
        ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á: ${esc(o.fromShop||'-')} ‚Üí ${esc(o.toShop||'-')} ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${esc(o.statusAt||'-')}
      </div>
      <div class="order-bd">
        <table>
          <thead>${th}</thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
      <div class="foot">
        <div class="flex-end">
          <select id="st-${o.booking}" class="input">${opts}</select>
          <button class="btnP" onclick="updateStatus('${o.booking}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
          <div style="min-width:10px"></div>
          <div>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏¥‡∏•: ${num(o.total)} ‡∏ö‡∏≤‡∏ó</div>
        </div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('a-result').innerHTML = html || '<div class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî</div>';
}

async function updateStatus(booking){
  const key = sessionStorage.getItem('adminKey') || '';
  const st  = document.getElementById(`st-${booking}`).value;
  const url = `${WEB_APP_URL}?action=update&adminKey=${encodeURIComponent(key)}&booking=${encodeURIComponent(booking)}&status=${encodeURIComponent(st)}`;
  try{
    const res = await j(url);
    if(!res.ok){ alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ / ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß)');
    loadAdmin();
  }catch(e){ alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
}
</script>
</body>
</html>
