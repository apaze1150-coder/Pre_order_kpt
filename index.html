<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Toy City ‚Äì Order Portal</title>

<!-- QRCode lib -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.5/build/qrcode.min.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:#2d3748;min-height:100vh;padding-bottom:40px
  }
  header{
    background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;
    padding:20px 24px;box-shadow:0 4px 6px rgba(0,0,0,.1);
    position:sticky;top:0;z-index:100
  }
  .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
  .logo{font-size:24px;font-weight:700;letter-spacing:.5px;display:flex;align-items:center;gap:10px}
  .logo::before{content:"üéÆ";font-size:28px}
  nav{display:flex;gap:12px;flex-wrap:wrap}
  button{padding:12px 18px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer}
  button.primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  button.secondary{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff}
  button.ghost{background:transparent;color:#fff;border:2px solid rgba(255,255,255,.85)}
  .wrap{max-width:1200px;margin:30px auto;padding:0 20px}
  .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:28px;margin-bottom:24px}
  h2{color:#1a202c;margin-bottom:20px;font-size:26px;border-bottom:3px solid #667eea;padding-bottom:12px;display:inline-block}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
  input,select{padding:12px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;min-width:200px;flex:1;transition:.2s}
  input:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.12)}
  .info-box{background:#ebf8ff;border-left:4px solid #3182ce;padding:14px;border-radius:8px;margin:10px 0}
  .alert{padding:12px;border-radius:10px;margin:10px 0}
  .alert.error{background:#fed7d7;color:#c53030;border-left:4px solid #c53030}
  .alert.success{background:#c6f6d5;color:#22543d;border-left:4px solid #22543d}
  .order-card{background:#fff;border:2px solid #e2e8f0;border-radius:14px;padding:18px;margin:16px 0}
  .order-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
  .left-head{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .booking-number{
    font-size: clamp(32px, 6vw, 56px) !important;
    font-weight: 800; line-height: 1.1; letter-spacing:.5px; color:#1a202c
  }
  .badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:700;color:#fff;background:linear-gradient(135deg,#667eea,#764ba2)}
  .badge.success{background:linear-gradient(135deg,#11998e,#38ef7d)}
  .badge.warning{background:linear-gradient(135deg,#ff6a00,#ee0979)}
  .muted{color:#4a5568;font-size:14px;margin:8px 0}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#edf2f7;border-radius:999px;padding:6px 10px;font-size:12px;color:#2d3748;border:1px solid #e2e8f0}
  .qr{width:96px;height:96px}
  .btn-line{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;border-radius:10px;overflow:hidden}
  th,td{padding:12px 10px;text-align:left;font-size:14px;border-bottom:1px solid #e2e8f0}
  th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700;text-transform:uppercase;font-size:12px;letter-spacing:.5px}
  tfoot td{background:#f7fafc;font-weight:700}
  .timeline{position:relative;margin-top:12px;padding-left:28px}
  .timeline::before{content:"";position:absolute;left:12px;top:0;bottom:0;width:4px;background:#e2e8f0;border-radius:2px}
  .step{position:relative;margin:10px 0 10px 0}
  .step .dot{
    position:absolute;left:-2px;top:2px;width:20px;height:20px;border-radius:50%;
    background:#cbd5e0;border:2px solid #fff;box-shadow:0 0 0 3px #e2e8f0
  }
  .step.active .dot{background:#667eea}
  .step .label{margin-left:12px;font-weight:700}
  .step .time{margin-left:12px;color:#718096;font-size:12px}
  .searchbar{display:flex;gap:10px;flex-wrap:wrap}
  .searchbar > * {flex:1;min-width:180px}
  @media (max-width:768px){.row{flex-direction:column} input,select,button{width:100%} table{font-size:12px}}
  @media print{
    header,nav,.searchbar,.btn-line,.admin-login{display:none}
    body{background:#fff}
    .order-card{page-break-inside:avoid;border:1px solid #ddd}
    .booking-number{font-size:48pt !important}
  }
</style>
</head>
<body>
<header>
  <div class="header-content">
    <div class="logo">Toy City ‚Äì Order Portal</div>
    <nav>
      <button class="ghost" onclick="showTab('tabCustomer')">üîç ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      <button class="ghost" onclick="showTab('tabAdmin')">‚öôÔ∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin</button>
    </nav>
  </div>
</header>

<div class="wrap">
  <!-- CUSTOMER -->
  <div id="tabCustomer" class="card">
    <h2>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á</h2>
    <div class="info-box">
      ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (PDPA) ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå <b>booking</b> ‡πÅ‡∏•‡∏∞ <b>token</b> ‡∏à‡∏≤‡∏Å URL ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    </div>
    <div id="c-result" class="mt"></div>
  </div>

  <!-- ADMIN -->
  <div id="tabAdmin" class="card" style="display:none">
    <h2>‚öôÔ∏è Admin Console</h2>

    <div id="adminLogin" class="admin-login">
      <div class="info-box">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
      <div class="row">
        <input id="a-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" onkeypress="if(event.key==='Enter') adminLogin()">
        <button class="secondary" onclick="adminLogin()">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>

    <div id="adminPanel" style="display:none">
      <div class="searchbar" style="margin:6px 0 14px">
        <select id="f-status" onchange="applyFilters()">
          <option value="">‚Äî ‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‚Äî</option>
          <option>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
          <option>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
          <option>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
          <option>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
        </select>
        <input id="f-booking" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏à‡∏≠‡∏á" oninput="applyFilters()">
        <select id="f-toshop" onchange="applyFilters()"><option value="">‚Äî ‡∏ó‡∏∏‡∏Å To Shop ‚Äî</option></select>
        <button class="secondary" onclick="loadOrders()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>
      <div id="a-result"></div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzc8m3R_sUQX3kDZEbYFYMwaNxrrju1VWkX6HGGCnUON9dR48p-woccIuddzk_8RxP_3g/exec'; // ‚Üê ‡πÉ‡∏™‡πà /exec ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
const ADMIN_PASS  = '6515';

/* ====== STATE ====== */
let adminKey = null;
let rawOrders = [];

/* ====== TAB ====== */
function showTab(id){
  document.getElementById('tabCustomer').style.display = (id==='tabCustomer')?'block':'none';
  document.getElementById('tabAdmin').style.display    = (id==='tabAdmin')?'block':'none';
}

/* ====== HELPERS ====== */
const esc = s => String(s??'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const num = n => Number(n||0).toLocaleString('th-TH');
function discLabel(v){
  const s = String(v ?? '').trim().toLowerCase();
  if (!s) return '‡πÑ‡∏°‡πà‡∏°‡∏µ';
  const m = s.match(/(\d+(?:\.\d+)?)\s*%/);
  if (m) return `${(+m[1]).toString().replace(/\.0+$/,'')}%`;
  const n = parseFloat(s);
  if (isNaN(n)) return s;
  const pct = n>1 ? n : n*100;
  return `${(+pct).toString().replace(/\.0+$/,'')}%`;
}
function statusBadgeClass(st){
  if (!st) return '';
  if (st.includes('‡∏à‡∏≠‡∏á')) return 'warning';
  if (st.includes('‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô') || st.includes('‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) return 'success';
  return '';
}

/* ====== CUSTOMER (PDPA deep link) ====== */
async function customerBoot(){
  const url = new URL(location.href);
  const booking = url.searchParams.get('booking');
  const token   = url.searchParams.get('token');
  const box = document.getElementById('c-result');

  if (!booking || !token){
    box.innerHTML = '<div class="alert">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>';
    return;
  }
  box.innerHTML = '<div class="alert">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á‚Ä¶</div>';
  try{
    const res = await fetch(`${WEB_APP_URL}?action=order&booking=${encodeURIComponent(booking)}&token=${encodeURIComponent(token)}`).then(r=>r.json());
    if (!res.ok || !res.data){ box.innerHTML = '<div class="alert error">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>'; return; }
    box.innerHTML = renderOrder(res.data,false,true);
    makeQr(booking);
  }catch(e){
    box.innerHTML = '<div class="alert error">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>';
  }
}

/* ====== ADMIN ====== */
function adminLogin(){
  const pass = document.getElementById('a-pass').value.trim();
  if (pass !== ADMIN_PASS){ alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
  adminKey = pass;
  document.getElementById('adminLogin').style.display='none';
  document.getElementById('adminPanel').style.display='block';
  loadOrders();
}
async function loadOrders(){
  const box = document.getElementById('a-result');
  box.innerHTML = '<div class="alert">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>';
  try{
    const res = await fetch(`${WEB_APP_URL}?action=list&adminKey=${encodeURIComponent(adminKey)}`).then(r=>r.json());
    if(!res.ok){ box.innerHTML = '<div class="alert error">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>'; return; }
    rawOrders = res.data || [];
    rebuildToShopFilter(rawOrders);
    applyFilters();
  }catch(e){ box.innerHTML = '<div class="alert error">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>'; }
}
function rebuildToShopFilter(orders){
  const sel = document.getElementById('f-toshop');
  const opts = new Set(['']);
  orders.forEach(o=>{ if (o.toShop) opts.add(o.toShop); });
  sel.innerHTML = '';
  for (const v of opts){
    const op = document.createElement('option');
    op.value = v; op.textContent = v ? v : '‚Äî ‡∏ó‡∏∏‡∏Å To Shop ‚Äî';
    sel.appendChild(op);
  }
}
function applyFilters(){
  const st = document.getElementById('f-status').value.trim();
  const bk = document.getElementById('f-booking').value.trim();
  const ts = document.getElementById('f-toshop').value.trim();

  const list = (rawOrders||[]).filter(o=>{
    if (st && o.status !== st) return false;
    if (bk && !String(o.booking).includes(bk)) return false;
    if (ts && (o.toShop||'') !== ts) return false;
    return true;
  });

  const box = document.getElementById('a-result');
  if (!list.length){ box.innerHTML = '<div class="alert">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>'; return; }
  box.innerHTML = list.map(o=>renderOrder(o,true,false)).join('');
  list.forEach(o=> makeQr(o.booking)); // ‡∏ß‡∏≤‡∏î QR ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
}

async function updateStatus(booking){
  const st = document.getElementById('st-'+booking).value;
  const res = await fetch(`${WEB_APP_URL}?action=update&adminKey=${encodeURIComponent(adminKey)}&booking=${encodeURIComponent(booking)}&status=${encodeURIComponent(st)}`).then(r=>r.json());
  if(res.ok){ alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°)'); loadOrders(); } else { alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
}

/* ====== RENDER ====== */
function renderOrder(o, includeControls, showTimeline){
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡∏ô‡πÑ‡∏´‡∏°
  const hasDisc     = o.items.some(it => String(it.disc||'').trim()     !== '');
  const hasDiscCode = o.items.some(it => String(it.discCode||'').trim() !== '');
  const hasDiscRule = o.items.some(it => String(it.discRule||'').trim() !== '');

  const ths = [
    '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î','‡∏£‡∏≤‡∏Ñ‡∏≤','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
    (hasDisc||hasDiscCode||hasDiscRule)?'‡∏£‡∏ß‡∏° (‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)':'‡∏£‡∏ß‡∏°'
  ];
  if (hasDisc)     ths.push('PROMOTION %');
  if (hasDiscCode) ths.push('PROMOTION CODE');
  if (hasDiscRule) ths.push('CONDITION');

  const rows = o.items.map(it=>{
    const label = discLabel(it.disc);
    const amtGross = Number(it.amountGross ?? it.amount ?? 0);
    const amtNet   = Number(it.amountNet   ?? it.amount ?? 0);
    let tds = `
      <td>${esc(it.code||'-')}</td>
      <td>${esc(it.desc||'-')}</td>
      <td align="right">${num(it.price||0)}</td>
      <td align="right">${num(it.qty||0)}</td>
      <td align="right">${
        (amtGross>amtNet)
          ? `<span style="text-decoration:line-through;color:#888">${num(amtGross)}</span> ‚Üí <b>${num(amtNet)}</b>`
          : `<b>${num(amtNet)}</b>`
      }</td>`;
    if (hasDisc)     tds += `<td>${esc(label)}</td>`;
    if (hasDiscCode) tds += `<td>${esc(String(it.discCode||'‡πÑ‡∏°‡πà‡∏°‡∏µ'))}</td>`;
    if (hasDiscRule) tds += `<td>${esc(String(it.discRule||'‡πÑ‡∏°‡πà‡∏°‡∏µ'))}</td>`;
    return `<tr>${tds}</tr>`;
  }).join('');

  const badgeClass = statusBadgeClass(o.status);
  const cardId = `card-${o.booking}`;

  // ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢ 4 ‡∏™‡πÄ‡∏ï‡πá‡∏õ
  const steps = [
    {key:'‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', icon:'üìù', label:'‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'},
    {key:'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',   icon:'üì¶', label:'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)'},
    {key:'‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô',  icon:'üè¨', label:'‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'},
    {key:'‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß',  icon:'‚úÖ', label:'‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'}
  ];
  function isActive(step){
    const s = o.status||'';
    if (step.key==='‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤') return s.includes('‡∏à‡∏≠‡∏á');
    if (step.key==='‡∏à‡∏±‡∏î‡∏™‡πà‡∏á')   return s.includes('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á');
    if (step.key==='‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô')  return s.includes('‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô');
    if (step.key==='‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß')  return s.includes('‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    return false;
  }
  const timeline = showTimeline ? `
    <div class="timeline">
      ${steps.map(st=>`
        <div class="step ${isActive(st)?'active':''}">
          <div class="dot"></div>
          <div class="label">${st.icon} ${st.label}</div>
          ${isActive(st)?`<div class="time">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${esc(o.statusAt||'-')}</div>`:''}
        </div>
      `).join('')}
    </div>` : '';

  const customerLine = `
    üë§ ${esc(o.customer.name||'')}${o.customer.last?' '+esc(o.customer.last):''}
    ¬∑ üìß ${esc(o.customer.email||'-')}
    ¬∑ üìû ${esc(o.customer.tel||'-')}
  `;

  const controls = includeControls ? `
    <div class="row" style="margin-top:10px;background:#f7fafc;padding:12px;border-radius:10px">
      <select id="st-${o.booking}">
        <option ${o.status==='‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'?'selected':''}>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option ${o.status.startsWith('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')?'selected':''}>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
        <option ${o.status==='‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
        <option ${o.status==='‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'?'selected':''}>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
      </select>
      <button class="primary" onclick="updateStatus('${o.booking}')">üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
      <button class="secondary" onclick="printOrder('${o.booking}')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á</button>
    </div>` : `
    <div class="btn-line">
      <button class="secondary" onclick="printOrder('${o.booking}')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á</button>
    </div>`;

  return `
  <div class="order-card" id="${cardId}">
    <div class="order-header">
      <div class="left-head">
        <div class="booking-number">üìã Booking #${esc(o.booking)}</div>
        <div class="chips">
          ${o.fromShop?`<span class="chip">From: ${esc(o.fromShop)}</span>`:''}
          ${o.toShop  ?`<span class="chip">To: ${esc(o.toShop)}</span>`:''}
        </div>
      </div>
      <span class="badge ${badgeClass}">${esc(o.status||'-')}</span>
    </div>

    <div class="muted">${customerLine}<br>üïê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${esc(o.statusAt||'-')}</div>

    ${timeline}

    <div style="display:flex;gap:16px;align-items:center;margin-top:8px;flex-wrap:wrap">
      <div>QR (‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤):</div>
      <canvas id="qr-${o.booking}" class="qr"></canvas>
    </div>

    <table>
      <thead><tr>${ths.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
      <tbody>${rows}</tbody>
      <tfoot>
        <tr>
          <td colspan="${(hasDisc||hasDiscCode||hasDiscRule)?5:4}" align="right"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></td>
          ${ (hasDisc||hasDiscCode||hasDiscRule)
              ? `<td colspan="${(hasDisc?1:0)+(hasDiscCode?1:0)+(hasDiscRule?1:0)}" align="right"><b>${num(o.total||0)} ‡∏ö‡∏≤‡∏ó</b></td>`
              : `<td align="right"><b>${num(o.total||0)} ‡∏ö‡∏≤‡∏ó</b></td>`}
        </tr>
      </tfoot>
    </table>

    ${controls}
  </div>`;
}

/* ====== QR ====== */
function makeQr(booking){
  const el = document.getElementById('qr-'+booking);
  if (!el) return;
  try{
    QRCode.toCanvas(el, String(booking), {width:96, margin:1});
  }catch(e){}
}

/* ====== PRINT (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ô‡∏±‡πâ‡∏ô ‡πÜ) ====== */
function printOrder(booking){
  const node = document.getElementById('card-'+booking);
  if (!node){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå'); return; }
  const html = `
  <html><head>
    <meta charset="utf-8"><title>Print Booking #${esc(booking)}</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#000}
      .order-card{border:1px solid #ddd;border-radius:12px;padding:18px}
      .booking-number{font-size:48pt;font-weight:800}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      th,td{border:1px solid #ccc;padding:8px;font-size:12pt}
      th{background:#eee}
      .chip{border:1px solid #ddd;border-radius:999px;padding:4px 8px}
    </style>
  </head>
  <body onload="window.print();setTimeout(()=>window.close(),300);">
    ${node.outerHTML}
  </body></html>`;
  const w = window.open('', '_blank');
  w.document.open(); w.document.write(html); w.document.close();
}

/* ====== BOOT ====== */
customerBoot();
</script>
</body>
</html>
