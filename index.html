<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Toy City ‚Äì Order Portal</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#667eea,#764ba2);color:#2d3748;min-height:100vh;padding-bottom:40px}
  header{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;padding:20px 24px;box-shadow:0 4px 6px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
  .header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
  .logo{font-size:24px;font-weight:700;letter-spacing:.5px;display:flex;align-items:center;gap:10px}
  .logo::before{content:"üéÆ";font-size:28px}
  nav{display:flex;gap:12px;flex-wrap:wrap}
  .wrap{max-width:1200px;margin:30px auto;padding:0 20px}
  .card{background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:28px;margin-bottom:24px}
  h2{color:#1a202c;margin-bottom:16px;font-size:24px;border-bottom:3px solid #667eea;padding-bottom:10px;display:inline-block}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
  input,select{padding:10px 14px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;min-width:180px}
  input:focus,select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
  button{padding:10px 16px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer}
  button.primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
  button.secondary{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff}
  button.success{background:linear-gradient(135deg,#11998e,#38ef7d);color:#fff}
  button.warning{background:linear-gradient(135deg,#ff6a00,#ee0979);color:#fff}
  button.ghost{background:transparent;color:#fff;border:2px solid rgba(255,255,255,.85)}
  .info-box{background:#ebf8ff;border-left:4px solid #3182ce;padding:12px;border-radius:8px;margin:8px 0}
  .alert{padding:10px;border-radius:10px;margin:10px 0}
  .alert.error{background:#fed7d7;color:#c53030;border-left:4px solid #c53030}
  .alert.success{background:#c6f6d5;color:#22543d;border-left:4px solid #22543d}
  .muted{color:#718096;font-size:14px;margin:6px 0}
  .order-card{background:#fff;border:2px solid #e2e8f0;border-radius:12px;padding:16px;margin:14px 0}
  .order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
  .booking-number{font-size:18px;font-weight:700;color:#1a202c}
  .badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:700;color:#fff;background:linear-gradient(135deg,#667eea,#764ba2)}
  .badge.success{background:linear-gradient(135deg,#11998e,#38ef7d)}
  .badge.warning{background:linear-gradient(135deg,#ff6a00,#ee0979)}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px;border-radius:10px;overflow:hidden}
  th,td{padding:10px 8px;text-align:left;font-size:14px;border-bottom:1px solid #e2e8f0}
  th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700;font-size:12px;letter-spacing:.4px;text-transform:uppercase}
  tfoot td{font-weight:700;background:#f7fafc}
  .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width:768px){.row{flex-direction:column} input,select,button{width:100%} table{font-size:12px}}
  @media print{button,nav,.filters{display:none}}
</style>
</head>
<body>
<header>
  <div class="header-content">
    <div class="logo">Toy City ‚Äì Order Portal</div>
    <nav>
      <button class="ghost" onclick="showTab('tabCustomer')">üîç ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</button>
      <button class="ghost" onclick="showTab('tabAdmin')">‚öôÔ∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin</button>
    </nav>
  </div>
</header>

<div class="wrap">
  <!-- CUSTOMER -->
  <div id="tabCustomer" class="card">
    <h2>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏à‡∏≠‡∏á</h2>
    <div class="info-box">‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏à‡∏≠‡∏á <b>6 ‡∏´‡∏•‡∏±‡∏Å</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
    <div class="row">
      <input id="c-booking" placeholder="‡πÄ‡∏ä‡πà‡∏ô 102380" maxlength="6" inputmode="numeric"
             oninput="this.value=this.value.replace(/\\D/g,'').slice(0,6)"
             onkeypress="if(event.key==='Enter') customerLookup()">
      <button class="primary" onclick="customerLookup()">üîç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
    </div>
    <div id="c-result"></div>
  </div>

  <!-- ADMIN -->
  <div id="tabAdmin" class="card" style="display:none">
    <h2>‚öôÔ∏è Admin Console</h2>
    <div id="adminLogin">
      <div class="info-box">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</div>
      <div class="row">
        <input id="a-pass" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin" onkeypress="if(event.key==='Enter') adminLogin()">
        <button class="secondary" onclick="adminLogin()">üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>

    <div id="adminPanel" style="display:none">
      <div class="row">
        <div class="filters">
          <select id="f-status" onchange="renderAdmin()">
            <option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          </select>
          <input id="f-booking" placeholder="‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏à‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 102380)" oninput="renderAdmin()">
          <select id="f-fromshop" onchange="renderAdmin()">
            <option value="">From Shop: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          </select>
        </div>
        <div class="tools">
          <button class="secondary" onclick="loadOrders()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>
      <div id="a-result"></div>
    </div>
  </div>
</div>

<script>
/* === ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Web App ( /exec ) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á === */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxGsiKNkWQOQRql0h1sWEZLsgoJXLiQyIWRkQ6pFbj2Oqp4S7keuiF5lpXaWRhjiAndAQ/exec';
const ADMIN_PASS  = '6515';

let adminKey = null;
let ordersCache = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏á

function showTab(id){
  document.getElementById('tabCustomer').style.display = (id==='tabCustomer')?'block':'none';
  document.getElementById('tabAdmin').style.display    = (id==='tabAdmin')?'block':'none';
}

/* ===== CUSTOMER ===== */
async function customerLookup(){
  const booking = document.getElementById('c-booking').value.trim();
  const box = document.getElementById('c-result');
  if (!/^[0-9]{6}$/.test(booking)){
    box.innerHTML = '<div class="alert error">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏à‡∏≠‡∏á 6 ‡∏´‡∏•‡∏±‡∏Å</div>';
    return;
  }
  box.innerHTML = '<div class="alert">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶</div>';
  try{
    const res = await fetch(`${WEB_APP_URL}?action=order&booking=${encodeURIComponent(booking)}`).then(r=>r.json());
    if(!res.ok || !res.data){ box.innerHTML = '<div class="alert error">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ</div>'; return; }
    box.innerHTML = renderOrder(res.data,false);
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="alert error">‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>';
  }
}

/* ===== ADMIN ===== */
function adminLogin(){
  const pass = document.getElementById('a-pass').value.trim();
  if (pass !== ADMIN_PASS){ alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
  adminKey = pass;
  document.getElementById('adminLogin').style.display='none';
  document.getElementById('adminPanel').style.display='block';
  loadOrders();
}

async function loadOrders(){
  const box = document.getElementById('a-result');
  box.innerHTML = '<div class="alert">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>';
  try{
    const res = await fetch(`${WEB_APP_URL}?action=list&adminKey=${encodeURIComponent(adminKey)}`).then(r=>r.json());
    if(!res.ok){ box.innerHTML = '<div class="alert error">‚ùå ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>'; return; }
    ordersCache = res.data || [];
    buildFilters(ordersCache);
    renderAdmin();
  }catch(e){
    console.error(e);
    box.innerHTML = '<div class="alert error">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>';
  }
}

function buildFilters(data){
  // Status options
  const stSel = document.getElementById('f-status');
  const statuses = Array.from(new Set(data.map(o=>o.status).filter(Boolean))).sort();
  stSel.innerHTML = '<option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + statuses.map(s=>`<option>${s}</option>`).join('');

  // From Shop options
  const fsSel = document.getElementById('f-fromshop');
  const shops = Array.from(new Set(data.map(o=>o.fromShop||'').filter(Boolean))).sort();
  fsSel.innerHTML = '<option value="">From Shop: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + shops.map(s=>`<option>${s}</option>`).join('');
}

function renderAdmin(){
  const st  = document.getElementById('f-status').value.trim();
  const bk  = document.getElementById('f-booking').value.trim();
  const fs  = document.getElementById('f-fromshop').value.trim();
  const box = document.getElementById('a-result');

  let list = ordersCache.slice();
  if (st) list = list.filter(o => (o.status||'') === st);
  if (bk) list = list.filter(o => String(o.booking||'').includes(bk));
  if (fs) list = list.filter(o => (o.fromShop||'') === fs);

  if (!list.length){ box.innerHTML = '<div class="alert">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</div>'; return; }
  box.innerHTML = list.map(o=>renderOrder(o,true)).join('');
}

async function updateStatus(booking){
  if (!adminKey){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô'); return; }
  const st = document.getElementById('st-'+booking).value;
  try{
    const res = await fetch(`${WEB_APP_URL}?action=update&adminKey=${encodeURIComponent(adminKey)}&booking=${encodeURIComponent(booking)}&status=${encodeURIComponent(st)}`).then(r=>r.json());
    if (res.ok){
      alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß (‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)');
      loadOrders();
    }else{
      alert('‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }catch(e){ alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); }
}

/* ===== Render ===== */
function renderOrder(o, includeControls){
  const statusAtDisplay = o.statusAt || '-';
  let badgeClass = '';
  if (o.status.includes('‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) badgeClass = 'warning';
  else if (o.status.includes('‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô') || o.status.includes('‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) badgeClass = 'success';

  const thead = `
    <tr>
      <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
      <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
      <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
      <th>‡∏£‡∏ß‡∏°</th>
      <th>PROMOTION %</th>
      <th>PROMOTION CODE</th>
      <th>CONDITION</th>
    </tr>`;

  const tbody = (o.items||[]).map(it=>`
    <tr>
      <td>${esc(it.code)||'-'}</td>
      <td>${esc(it.desc)||'-'}</td>
      <td align="right">${num(it.price)}</td>
      <td align="right">${num(it.qty)}</td>
      <td align="right">${num(it.amount)}</td>
      <td>${displayOrNone(it.disc)}</td>
      <td>${displayOrNone(it.discCode)}</td>
      <td>${displayOrNone(it.discRule)}</td>
    </tr>`).join('');

  const controls = includeControls ? `
    <div class="tools">
      <select id="st-${o.booking}">
        <option ${o.status==='‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'?'selected':''}>‡∏à‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
        <option ${o.status.startsWith('‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')?'selected':''}>‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 7 ‡∏ß‡∏±‡∏ô)</option>
        <option ${o.status==='‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
        <option ${o.status==='‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß'?'selected':''}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</option>
        <option ${o.status==='‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'?'selected':''}>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
      </select>
      <button class="primary" onclick="updateStatus('${o.booking}')">üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
      <button class="warning" onclick="printThermal('${o.booking}')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á (Thermal)</button>
      <button class="success" onclick="window.print()">üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå A4</button>
    </div>
  ` : `
    <div class="tools">
      <button class="warning" onclick="printThermal('${o.booking}')">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏à‡∏≠‡∏á (Thermal)</button>
      <button class="success" onclick="window.print()">üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå A4</button>
    </div>
  `;

  return `
    <div class="order-card">
      <div class="order-header">
        <div class="booking-number">üìã Booking #${o.booking}</div>
        <span class="badge ${badgeClass}">${o.status}</span>
      </div>
      <div class="muted">
        üë§ ${esc(o.customer?.name)||''} ${esc(o.customer?.last)||''} ¬∑
        üìß ${esc(o.customer?.email)||'-'} ¬∑
        üìû ${esc(o.customer?.tel)||'-'}<br>
        üè¨ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô: ${displayOrNone(o.fromShop)} ‚Üí ${displayOrNone(o.toShop)}<br>
        üïê ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${statusAtDisplay}
      </div>
      <table>
        <thead>${thead}</thead>
        <tbody>${tbody}</tbody>
        <tfoot>
          <tr>
            <td colspan="7" align="right"><b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b></td>
            <td align="right"><b>${num(o.total)} ‡∏ö‡∏≤‡∏ó</b></td>
          </tr>
        </tfoot>
      </table>
      ${controls}
    </div>`;
}

/* ===== Thermal Print (RawBT) ===== */
const TH = { cols: 32, topMargin: 0, bottomMargin: 5, cutMode: 'partial' }; // 58mm ‡πÉ‡∏ä‡πâ 32 cols
function lineOf(ch='-', len=TH.cols){ return (ch.repeat(len)).slice(0,len) + '\n'; }
function cutCmd(feed=TH.bottomMargin){
  let s=''; s+='\x1B'+'d'+String.fromCharCode(Math.max(0,feed));
  s+=(TH.cutMode==='full')?'\x1D'+'V'+'\x01':'\x1D'+'V'+'\x00'; return s;
}
function escposFor(o){
  const NL='\n';
  let s=''; s+='\x1B@'; if(TH.topMargin>0) s+='\x1Bd'+String.fromCharCode(TH.topMargin);
  s+='\x1B!\x38'+'TOY CITY'+NL; s+='\x1B!\x00';
  s+='Booking #'+o.booking+NL;
  s+=lineOf('=');
  s+=(o.customer?.name||'')+' '+(o.customer?.last||'')+NL;
  s+=(o.customer?.tel||'')+'  '+(o.customer?.email||'')+NL;
  s+='Route: '+(o.fromShop||'-')+' -> '+(o.toShop||'-')+NL;
  s+=lineOf();

  (o.items||[]).forEach(it=>{
    s+=(it.code||'')+'  '+(it.qty||0)+' x '+(it.price||0)+NL;
    s+=(it.desc||'').slice(0,TH.cols)+NL;
    // ‡πÇ‡∏õ‡∏£‡∏Ø
    const d=(it.disc||'‡πÑ‡∏°‡πà‡∏°‡∏µ'), c=(it.discCode||'‡πÑ‡∏°‡πà‡∏°‡∏µ'), r=(it.discRule||'‡πÑ‡∏°‡πà‡∏°‡∏µ');
    s+=('PROMO: '+d).slice(0,TH.cols)+NL;
    s+=('CODE : '+c).slice(0,TH.cols)+NL;
    s+=('COND : '+r).slice(0,TH.cols)+NL;
    s+=lineOf();
  });

  s+='Total: '+(o.total||0)+NL;
  s+=lineOf(); s+='--- ‡∏â‡∏µ‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ô‡∏µ‡πâ ---'+NL;
  s+='\x1Bd'+'\x06'; // feed ‡πÄ‡∏û‡∏¥‡πà‡∏°
  s+=cutCmd();
  return s;
}
async function printThermal(booking){
  try{
    const data = await fetch(`${WEB_APP_URL}?action=order&booking=${encodeURIComponent(booking)}`).then(r=>r.json());
    if (!data.ok || !data.data){ alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå'); return; }
    const esc = escposFor(data.data);
    const b64 = btoa(unescape(encodeURIComponent(esc)));
    const uri = `intent://print/#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;S.b64=${b64};end`;
    try{ window.location.href = uri; }catch(e){ window.location.href = 'rawbt://'+b64; }
  }catch(e){ alert('‚ùå ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ'); }
}

/* ===== Utils ===== */
function num(n){ return Number(n||0).toLocaleString('th-TH'); }
function esc(s){ return String(s==null?'':s); }
function displayOrNone(v){ const t=String(v==null?'':v).trim(); return t?esc(t):'‡πÑ‡∏°‡πà‡∏°‡∏µ'; }

/* default tab */
showTab('tabCustomer');
</script>
</body>
</html>
